<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾…è¾¦äº‹é …æ¸…å–®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', 'KaiTi', 'æ¨™æ¥·é«”', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #000000;
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 20px;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
        }

        h1 {
            color: #000000;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-group label {
            font-size: 12px;
            color: #000000;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-btn {
            grid-column: 1 / -1;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .add-btn:active {
            transform: translateY(0);
        }

        .current-date {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .todo-list {
            list-style: none;
        }

        .todo-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
            color: #000000;
            table-layout: auto;
        }

        .todo-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .todo-table th {
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .todo-table th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .todo-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
            font-size: 12px;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            line-height: 1.4;
        }

        .todo-table tr {
            transition: background 0.2s;
        }

        .todo-table tbody tr:hover {
            background: #f8f9fa;
        }

        .todo-table tbody tr.completed {
            opacity: 0.6;
        }

        .todo-table tbody tr.completed td:nth-child(2) {
            text-decoration: line-through;
        }

        .todo-table tbody tr.overdue {
            background: #ffcccc !important;  /* æ·±ä¸€é»çš„ç´…è‰²èƒŒæ™¯ */
            border-left: 6px solid #cc0000 !important;  /* æ·±ç´…è‰²ç²—é‚Šæ¡† */
            box-shadow: 0 0 0 2px #ff4444;  /* æ›´æ˜é¡¯çš„é™°å½± */
        }
        
        .todo-table tbody tr.overdue:hover {
            background: #ffb3b3 !important;  /* hover æ™‚æ›´æ·±çš„ç´… */
        }

        .todo-table tbody tr.priority-veryhigh {
            border-left: 6px solid #ff6b6b;
            background: #ffe0e0 !important;
        }

        .todo-table tbody tr.priority-high {
            border-left: 5px solid #4dabf7;
            background: #d0ebff !important;
        }

        .todo-table tbody tr.priority-medium {
            border-left: 4px solid #ffd93d;
        }

        .todo-table tbody tr.priority-low {
            border-left: 4px solid #51cf66;
        }

        .todo-table tbody tr.priority-verylow {
            border-left: 4px solid #74c0fc;
        }

        .editable-cell {
            cursor: pointer;
            position: relative;
            user-select: text; /* å…è¨±é¸å–æ–‡å­— */
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .editable-cell:hover::after {
            content: 'âœï¸';
            position: absolute;
            right: 5px;
            font-size: 12px;
        }
        
        /* é¸å–æ–‡å­—æ™‚çš„æ¨£å¼ */
        .editable-cell::selection {
            background: #b3d4fc;
            color: #000;
        }
        
        .editable-cell::-moz-selection {
            background: #b3d4fc;
            color: #000;
        }

        .todo-table tbody tr.in-pack td:first-child {
            padding-left: 20px;
        }

        .pack-header-row {
            border-left: none !important;
        }

        .divider-row {
            border-left: none !important;
        }

        .edit-input {
            width: 100%;
            padding: 5px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 14px;
        }

        .edit-select {
            width: 100%;
            padding: 5px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 14px;
            position: relative;
            z-index: 1000;
        }

        .category-badge,
        .priority-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
        }

        .category-work {
            background: #d0e7ff;
            color: #000000;
        }

        .category-personal {
            background: #f3d9fa;
            color: #000000;
        }

        .category-urgent {
            background: #ffe0e0;
            color: #000000;
        }

        .category-other {
            background: #e9ecef;
            color: #000000;
        }

        .category-custom {
            background: #d0e7ff;
            color: #000000;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
        }

        .status-notstarted {
            background: #e9ecef;
            color: #000000;
        }

        .status-inprogress {
            background: #d0ebff;
            color: #000000;
        }

        .status-pending {
            background: #fff3bf;
            color: #000000;
        }

        .status-blocked {
            background: #ffe0e0;
            color: #000000;
        }

        .priority-veryhigh {
            background: #ffcccc;
            color: #000000;
            font-weight: bold;
            animation: pulse 10s infinite;
        }

        .priority-high {
            background: #ffd9d9;
            color: #000000;
            font-weight: bold;
        }

        .priority-medium {
            background: #fff3bf;
            color: #000000;
        }

        .priority-low {
            background: #d3f9d8;
            color: #000000;
        }

        .priority-verylow {
            background: #d0ebff;
            color: #000000;
        }

        .priority-urgent {
            background: #ffd9d9;
            color: #000000;
            font-weight: bold;
        }

        .priority-veryurgent {
            background: #ffcccc;
            color: #000000;
            font-weight: bold;
            animation: pulse 10s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        .overdue-text {
            color: #cc0000 !important;
            font-weight: 900;
            text-shadow: 0 0 2px rgba(204, 0, 0, 0.3);
        }

        .todo-actions {
            display: flex;
            gap: 8px;
        }

        .delete-btn {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .pack-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            margin: 25px 0 10px 0;
            border-radius: 10px;
            color: white;
        }

        .pack-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .pack-icon {
            font-size: 20px;
        }

        .pack-name {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .pack-count {
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
        }

        .pack-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .pack-progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .pack-divider {
            margin: 30px 0 15px 0;
            padding: 10px 15px;
            background: #f0f0f0;
            border-radius: 8px;
            color: #666;
            font-weight: 500;
            font-size: 14px;
        }

        .todo-item.in-pack {
            margin-left: 20px;
            border-left-width: 3px;
        }

        .completed-section {
            margin-top: 30px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }

        .completed-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #000000;
            transition: background 0.2s;
            margin-bottom: 10px;
        }

        .completed-header:hover {
            background: #e9ecef;
        }

        #completedToggleIcon {
            font-size: 12px;
            transition: transform 0.2s;
        }

        @media (max-width: 768px) {
            .todo-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .input-section {
                grid-template-columns: 1fr;
            }

            .todo-item.in-pack {
                margin-left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="mainTitle" contenteditable="true" style="cursor: text; outline: none;" onblur="saveTitle()" title="é»æ“Šç·¨è¼¯æ¨™é¡Œ">ğŸ“ å¾…è¾¦äº‹é …æ¸…å–® <span style="font-size: 12px; color: #999; font-weight: normal;">v2025.01</span></h1>
        
        <!-- è¤‡è£½è²¼ä¸ŠåŠŸèƒ½èªªæ˜ -->
        <div id="copyPasteInfo" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
                <strong style="font-size: 16px;">ğŸ’¡ è¤‡è£½è²¼ä¸ŠåŠŸèƒ½å·²å•Ÿç”¨</strong>
                <div style="font-size: 13px; margin-top: 8px; line-height: 1.6; opacity: 0.95;">
                    <span style="display: inline-block; margin-right: 20px;">ğŸ“‹ <strong>é¸å–æ–‡å­—</strong> + Ctrl+Cï¼šè¤‡è£½åˆ° Excel/Word</span>
                    <span style="display: inline-block; margin-right: 20px;">ğŸ“‹ <strong>é»é¸ä¸€è¡Œ</strong> + Ctrl+Cï¼šè¤‡è£½é …ç›®</span>
                    <span style="display: inline-block; margin-right: 20px;">ğŸ“‹ <strong>Ctrl+V</strong>ï¼šè²¼ä¸Šé …ç›®</span>
                    <span style="display: inline-block;">ğŸ“‹ <strong>å³éµ</strong>ï¼šå¿«æ·é¸å–®</span>
                </div>
            </div>
            <button onclick="document.getElementById('copyPasteInfo').style.display='none'" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; margin-left: 15px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                çŸ¥é“äº†
            </button>
        </div>
        
        <div id="statistics" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: 600; color: #667eea;" id="statTotal">0</div>
                    <div style="font-size: 12px; color: #666;">ç¸½è¨ˆ</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 600; color: #ff5252;" id="statIncomplete">0</div>
                    <div style="font-size: 12px; color: #666;">å¾…è™•ç†</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 600; color: #28a745;" id="statCompleted">0</div>
                    <div style="font-size: 12px; color: #666;">å·²å®Œæˆ</div>
                </div>
                <div>
                    <div style="font-size: 28px; font-weight: 900; color: #cc0000; text-shadow: 0 0 4px rgba(204, 0, 0, 0.5); animation: pulse 10s infinite;" id="statOverdue">0</div>
                    <div style="font-size: 12px; color: #666; font-weight: 600;">âš ï¸ å·²é€¾æœŸ</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 600; color: #d50000;" id="statUrgent">0</div>
                    <div style="font-size: 12px; color: #666;">éå¸¸ç·Šæ€¥</div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <button onclick="exportData()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                ğŸ“¤ åŒ¯å‡ºè³‡æ–™
            </button>
            <button onclick="document.getElementById('importFile').click()" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                ğŸ“¥ åŒ¯å…¥è³‡æ–™
            </button>
            <button id="undoBtn" onclick="undoAction()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;" disabled>
                â†¶ Undo
            </button>
            <button id="redoBtn" onclick="redoAction()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;" disabled>
                â†· Redo
            </button>
            <button onclick="pasteTodo()" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                ğŸ“‹ è²¼ä¸Š
            </button>
            <button onclick="copySelectedItems()" style="padding: 10px 20px; background: #20c997; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;" title="è¤‡è£½å‹¾é¸çš„é …ç›®">
                â˜‘ï¸ è¤‡è£½é¸å–
            </button>
            <button onclick="copyTableToClipboard()" style="padding: 10px 20px; background: #6f42c1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;" title="è¤‡è£½æ•´å€‹è¡¨æ ¼åˆ° Excel">
                ğŸ“Š è¤‡è£½è¡¨æ ¼
            </button>
            <button onclick="clearCompletedData()" style="padding: 10px 20px; background: #ffc107; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                ğŸ—‘ï¸ æ¸…ç©ºå·²å®Œæˆ
            </button>
            <button onclick="clearIncompleteData()" style="padding: 10px 20px; background: #ff5252; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                ğŸ—‘ï¸ æ¸…ç©ºå¾…è¾¦
            </button>
            <button onclick="clearAllData()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨
            </button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)" />
        </div>
        
        <div class="current-date" id="currentDate"></div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <span style="font-weight: 600; color: #000;">æ’åºæ–¹å¼ï¼š</span>
                <button onclick="setSortMode('pack')" id="sortPack" class="sort-btn active" style="padding: 8px 16px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    ğŸ“¦ æŒ‰çµ„åˆ¥
                </button>
                <button onclick="setSortMode('due')" id="sortDue" class="sort-btn" style="padding: 8px 16px; border: 2px solid #ccc; background: white; color: #000; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    ğŸ“… åˆ°æœŸæ—¥
                </button>
                <button onclick="setSortMode('balance')" id="sortBalance" class="sort-btn" style="padding: 8px 16px; border: 2px solid #ccc; background: white; color: #000; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    â±ï¸ å‰©é¤˜å¤©æ•¸
                </button>
                <button onclick="setSortMode('priority')" id="sortPriority" class="sort-btn" style="padding: 8px 16px; border: 2px solid #ccc; background: white; color: #000; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    â­ å„ªå…ˆç´š
                </button>
                <button onclick="setSortMode('category')" id="sortCategory" class="sort-btn" style="padding: 8px 16px; border: 2px solid #ccc; background: white; color: #000; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    ğŸ“ åˆ†é¡
                </button>
                <button onclick="toggleSortOrder()" id="sortOrder" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    â–² å‡åº
                </button>
            </div>
        </div>
        
        <!-- ç¯©é¸å€åŸŸ -->
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                <span style="font-weight: 600; color: #000;">ğŸ” ç¯©é¸ï¼š</span>
                <button onclick="clearAllFilters()" style="padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    âœ–ï¸ æ¸…é™¤æ‰€æœ‰ç¯©é¸
                </button>
                <span id="filterCount" style="font-size: 13px; color: #666;"></span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                <!-- å®Œæˆç‹€æ…‹ç¯©é¸ -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">å®Œæˆç‹€æ…‹</label>
                    <select id="filterCompleted" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="false">âŒ æœªå®Œæˆ</option>
                        <option value="true">âœ… å·²å®Œæˆ</option>
                    </select>
                </div>
                
                <!-- å„ªå…ˆç´šç¯©é¸ -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">å„ªå…ˆç´š</label>
                    <select id="filterPriority" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="veryhigh">éå¸¸ç·Šæ€¥!!</option>
                        <option value="high">ç·Šæ€¥</option>
                        <option value="medium">æ™®é€š</option>
                        <option value="low">ä¸æ€¥</option>
                        <option value="verylow">éå¸¸ä¸æ€¥</option>
                    </select>
                </div>
                
                <!-- ç‹€æ…‹ç¯©é¸ -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">Status</label>
                    <select id="filterStatus" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="notstarted">å°šæœªé–‹å§‹</option>
                        <option value="inprogress">é€²è¡Œä¸­</option>
                        <option value="pending">ç­‰å¾…ä¸­</option>
                        <option value="blocked">å—é˜»</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                </div>
                
                <!-- å›°é›£åº¦ç¯©é¸ -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">å›°é›£åº¦</label>
                    <select id="filterDifficulty" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="veryeasy">ğŸ˜Š éå¸¸ç°¡å–®</option>
                        <option value="easy">ğŸ™‚ ç°¡å–®</option>
                        <option value="medium">ğŸ˜ æ™®é€š</option>
                        <option value="hard">ğŸ˜° å›°é›£</option>
                        <option value="veryhard">ğŸ˜± éå¸¸å›°é›£</option>
                    </select>
                </div>
                
                <!-- åˆ†é¡ç¯©é¸ -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">Category</label>
                    <input type="text" id="filterCategory" onkeyup="applyFilters()" placeholder="è¼¸å…¥åˆ†é¡åç¨±..." style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;" />
                </div>
                
                <!-- Pack ç¯©é¸ -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">Pack</label>
                    <input type="text" id="filterPack" onkeyup="applyFilters()" placeholder="è¼¸å…¥ Pack åç¨±..." style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;" />
                </div>
                
                <!-- éæœŸç‹€æ…‹ç¯©é¸ -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">éæœŸç‹€æ…‹</label>
                    <select id="filterOverdue" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="true">âš ï¸ å·²éæœŸ</option>
                        <option value="false">â° æœªéæœŸ</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <label>å¾…è¾¦äº‹é …åç¨± *</label>
                <input type="text" id="todoInput" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …..." />
            </div>
            
            <div class="input-group">
                <label>Category</label>
                <input type="text" id="categoryInput" placeholder="è¼¸å…¥åˆ†é¡..." />
            </div>
            
            <div class="input-group">
                <label>Priority</label>
                <select id="priorityInput" onchange="updatePriorityColor(this)">
                    <option value="veryhigh" style="background: #cc0000; color: white; font-weight: bold;">éå¸¸ç·Šæ€¥!!</option>
                    <option value="high" style="background: #ff6666; color: white;">ç·Šæ€¥</option>
                    <option value="medium" selected>æ™®é€š</option>
                    <option value="low">ä¸æ€¥</option>
                    <option value="verylow">éå¸¸ä¸æ€¥</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Due Date *</label>
                <input type="text" id="dueDateManual" placeholder="å¿«é€Ÿè¼¸å…¥ï¼š0115 æˆ– 1-15 æˆ– 20250115" style="width: 100%; margin-bottom: 5px;" />
                <input type="date" id="dueInput" style="width: 100%;" />
                <div style="font-size: 11px; color: #666; margin-top: 3px;">ğŸ“ æ‰‹å‹•è¼¸å…¥ï¼ˆæ²’å¹´ä»½é è¨­ä»Šå¹´ï¼‰æˆ– ğŸ“… ç”¨æ—¥æ›†é¸æ“‡</div>
            </div>
            
            <div class="input-group">
                <label>Combine Pack</label>
                <input type="text" id="combinepackInput" placeholder="çµ„åˆåŒ…åç¨±" />
            </div>
            
            <div class="input-group">
                <label>Status</label>
                <select id="statusInput" onchange="toggleCustomStatusInput()">
                    <option value="">æœªè¨­å®š</option>
                    <option value="notstarted">å°šæœªé–‹å§‹</option>
                    <option value="inprogress">é€²è¡Œä¸­</option>
                    <option value="pending">ç­‰å¾…ä¸­</option>
                    <option value="blocked">å—é˜»</option>
                    <option value="completed">å·²å®Œæˆ</option>
                    <option value="custom">å…¶ä»–...</option>
                </select>
            </div>
            
            <div class="input-group" id="customStatusGroup" style="display: none;">
                <label>è‡ªè¨‚ç‹€æ…‹</label>
                <input type="text" id="customStatusInput" placeholder="è¼¸å…¥è‡ªè¨‚ç‹€æ…‹åç¨±" />
            </div>
            
            <div class="input-group">
                <label>Remark</label>
                <input type="text" id="remarkInput" placeholder="å‚™è¨»èªªæ˜" />
            </div>
            
            <div class="input-group">
                <label>é–‹å§‹æ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <input type="text" id="startDateManual" placeholder="å¿«é€Ÿè¼¸å…¥ï¼š1023 æˆ– 10-23" style="width: 120px; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 13px;" />
                    <input type="date" id="startDateInput" style="flex: 1;" />
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 3px;">ğŸ“… å¿«é€Ÿè¼¸å…¥ç¯„ä¾‹ï¼š1023 = ä»Šå¹´10æœˆ23æ—¥ï¼Œä¸å¡«å¹´ä»½é è¨­ä»Šå¹´</div>
            </div>
            
            <div class="input-group">
                <label>å›°é›£åº¦</label>
                <select id="difficultyInput">
                    <option value="">æœªè¨­å®š</option>
                    <option value="veryeasy">ğŸ˜Š éå¸¸ç°¡å–®</option>
                    <option value="easy">ğŸ™‚ ç°¡å–®</option>
                    <option value="medium" selected>ğŸ˜ æ™®é€š</option>
                    <option value="hard">ğŸ˜° å›°é›£</option>
                    <option value="veryhard">ğŸ˜± éå¸¸å›°é›£</option>
                </select>
            </div>
            
            <button class="add-btn" onclick="addTodo()">â• æ–°å¢å¾…è¾¦äº‹é …</button>
        </div>

        <div id="todoList">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/>
                </svg>
                <p>é‚„æ²’æœ‰å¾…è¾¦äº‹é …ï¼Œé–‹å§‹æ–°å¢ä¸€å€‹å§ï¼</p>
            </div>
        </div>
    </div>

    <script>
        let todos = JSON.parse(localStorage.getItem('todos')) || [];
        let undoHistory = [];
        let redoHistory = [];
        const MAX_UNDO_HISTORY = 10;
        let currentSortMode = 'pack'; // pack, due, balance, priority, category
        let currentFilters = {
            completed: '',
            priority: '',
            status: '',
            difficulty: '',
            category: '',
            pack: '',
            overdue: ''
        };
        let sortAscending = true;

        // å„²å­˜åˆ° undo æ­·å²
        function saveToHistory() {
            undoHistory.push(JSON.parse(JSON.stringify(todos)));
            if (undoHistory.length > MAX_UNDO_HISTORY) {
                undoHistory.shift();
            }
            // æ¸…ç©º redo æ­·å²ï¼ˆå› ç‚ºåšäº†æ–°æ“ä½œï¼‰
            redoHistory = [];
            updateUndoRedoButtons();
        }

        // æ›´æ–° Undo/Redo æŒ‰éˆ•ç‹€æ…‹
        function updateUndoRedoButtons() {
            updateUndoButton();
            updateRedoButton();
        }

        // æ›´æ–° Undo æŒ‰éˆ•ç‹€æ…‹
        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            if (undoHistory.length > 0) {
                undoBtn.disabled = false;
                undoBtn.style.background = '#6c757d';
                undoBtn.style.cursor = 'pointer';
            } else {
                undoBtn.disabled = true;
                undoBtn.style.background = '#c0c0c0';
                undoBtn.style.cursor = 'not-allowed';
            }
        }

        // æ›´æ–° Redo æŒ‰éˆ•ç‹€æ…‹
        function updateRedoButton() {
            const redoBtn = document.getElementById('redoBtn');
            if (redoHistory.length > 0) {
                redoBtn.disabled = false;
                redoBtn.style.background = '#6c757d';
                redoBtn.style.cursor = 'pointer';
            } else {
                redoBtn.disabled = true;
                redoBtn.style.background = '#c0c0c0';
                redoBtn.style.cursor = 'not-allowed';
            }
        }

        // Undo æ“ä½œ
        function undoAction() {
            if (undoHistory.length === 0) {
                alert('æ²’æœ‰å¯ä»¥å¾©åŸçš„æ“ä½œï¼');
                return;
            }
            
            // å„²å­˜ç•¶å‰ç‹€æ…‹åˆ° redo æ­·å²
            redoHistory.push(JSON.parse(JSON.stringify(todos)));
            if (redoHistory.length > MAX_UNDO_HISTORY) {
                redoHistory.shift();
            }
            
            todos = undoHistory.pop();
            saveTodos();
            updateStatistics();
            updateUndoRedoButtons();
            renderTodos();
        }

        // Redo æ“ä½œ
        function redoAction() {
            if (redoHistory.length === 0) {
                alert('æ²’æœ‰å¯ä»¥é‡åšçš„æ“ä½œï¼');
                return;
            }
            
            // å„²å­˜ç•¶å‰ç‹€æ…‹åˆ° undo æ­·å²
            undoHistory.push(JSON.parse(JSON.stringify(todos)));
            if (undoHistory.length > MAX_UNDO_HISTORY) {
                undoHistory.shift();
            }
            
            todos = redoHistory.pop();
            saveTodos();
            updateStatistics();
            updateUndoRedoButtons();
            renderTodos();
        }

        // è§£ææ‰‹å‹•è¼¸å…¥çš„æ—¥æœŸ
        function parseManualDate(input) {
            if (!input) return null;
            
            // ç§»é™¤æ‰€æœ‰éæ•¸å­—å’Œé€£å­—è™Ÿã€æ–œç·š
            let cleaned = input.replace(/[^0-9-\/]/g, '');
            
            // ç²å–ç•¶å‰å¹´ä»½
            const currentYear = new Date().getFullYear();
            
            // æ ¼å¼ï¼šMMDD (4ä½æ•¸å­—ï¼Œæ²’æœ‰å¹´ä»½) - é è¨­ä»Šå¹´
            if (/^\d{4}$/.test(cleaned)) {
                const month = cleaned.substring(0, 2);
                const day = cleaned.substring(2, 4);
                return `${currentYear}-${month}-${day}`;
            }
            
            // æ ¼å¼ï¼šM-DD æˆ– MM-DD (æ²’æœ‰å¹´ä»½) - é è¨­ä»Šå¹´
            if (/^\d{1,2}-\d{1,2}$/.test(cleaned)) {
                const parts = cleaned.split('-');
                const month = parts[0].padStart(2, '0');
                const day = parts[1].padStart(2, '0');
                return `${currentYear}-${month}-${day}`;
            }
            
            // æ ¼å¼ï¼šM/DD æˆ– MM/DD (æ²’æœ‰å¹´ä»½) - é è¨­ä»Šå¹´
            if (/^\d{1,2}\/\d{1,2}$/.test(cleaned)) {
                const parts = cleaned.split('/');
                const month = parts[0].padStart(2, '0');
                const day = parts[1].padStart(2, '0');
                return `${currentYear}-${month}-${day}`;
            }
            
            // æ ¼å¼ï¼šYYYYMMDD (8ä½æ•¸å­—)
            if (/^\d{8}$/.test(cleaned)) {
                const year = cleaned.substring(0, 4);
                const month = cleaned.substring(4, 6);
                const day = cleaned.substring(6, 8);
                return `${year}-${month}-${day}`;
            }
            
            // æ ¼å¼ï¼šYYYY-MM-DD æˆ– YYYY-M-D
            if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(cleaned)) {
                const parts = cleaned.split('-');
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // æ ¼å¼ï¼šYYYY/MM/DD
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(input)) {
                const parts = input.split('/');
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return null;
        }

        // æ›´æ–°ç•¶å‰æ—¥æœŸé¡¯ç¤º
        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            const timeStr = now.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentDate').innerHTML = `
                <div style="font-size: 24px; font-weight: 700; color: #667eea; text-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);">
                    ğŸ“… ${dateStr}
                </div>
                <div style="font-size: 18px; font-weight: 600; color: #28a745; margin-top: 5px;">
                    ğŸ•’ ${timeStr}
                </div>
            `;
        }
        
        // æ›´æ–° Priority é¸å–®é¡è‰²
        function updatePriorityColor(selectEl) {
            const value = selectEl.value;
            if (value === 'veryhigh') {
                selectEl.style.background = '#cc0000';
                selectEl.style.color = 'white';
                selectEl.style.fontWeight = 'bold';
            } else if (value === 'high') {
                selectEl.style.background = '#ff6666';
                selectEl.style.color = 'white';
                selectEl.style.fontWeight = 'normal';
            } else {
                selectEl.style.background = '';
                selectEl.style.color = '';
                selectEl.style.fontWeight = '';
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStatistics() {
            const statDiv = document.getElementById('statistics');
            
            if (todos.length === 0) {
                statDiv.style.display = 'none';
                return;
            }
            
            statDiv.style.display = 'block';
            
            const total = todos.length;
            const incomplete = todos.filter(t => !t.completed).length;
            const completed = todos.filter(t => t.completed).length;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const overdue = todos.filter(t => !t.completed && new Date(t.due) < today).length;
            const urgent = todos.filter(t => !t.completed && t.priority === 'veryhigh').length;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statIncomplete').textContent = incomplete;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statOverdue').textContent = overdue;
            document.getElementById('statUrgent').textContent = urgent;
            
            // é¡¯ç¤ºéæœŸè­¦å‘Š
            updateOverdueAlert(overdue);
        }
        
        // æ›´æ–°éæœŸè­¦å‘Šæ©«å¹…
        function updateOverdueAlert(overdueCount) {
            let alertDiv = document.getElementById('overdueAlert');
            
            if (overdueCount > 0) {
                // æœ‰éæœŸé …ç›®ï¼Œé¡¯ç¤ºè­¦å‘Š
                if (!alertDiv) {
                    alertDiv = document.createElement('div');
                    alertDiv.id = 'overdueAlert';
                    alertDiv.style.cssText = `
                        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
                        color: white;
                        padding: 15px 20px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        box-shadow: 0 4px 16px rgba(204, 0, 0, 0.5);
                        animation: shake 0.5s ease;
                        border: 3px solid #ff0000;
                    `;
                    
                    // æ’å…¥åˆ°çµ±è¨ˆå€åŸŸå¾Œé¢
                    const statsDiv = document.getElementById('statistics');
                    statsDiv.parentNode.insertBefore(alertDiv, statsDiv.nextSibling);
                }
                
                alertDiv.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">
                            âš ï¸ æ³¨æ„ï¼æ‚¨æœ‰ ${overdueCount} å€‹é …ç›®å·²éæœŸ
                        </div>
                        <div style="font-size: 12px; opacity: 0.95;">
                            è«‹å„˜å¿«è™•ç†éæœŸé …ç›®ï¼Œæˆ–æ›´æ–°åˆ°æœŸæ—¥æœŸ
                        </div>
                    </div>
                    <button onclick="scrollToFirstOverdue()" style="
                        background: rgba(255,255,255,0.2);
                        border: 2px solid rgba(255,255,255,0.5);
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        margin-left: 15px;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        æŸ¥çœ‹éæœŸé …ç›® â†’
                    </button>
                `;
                alertDiv.style.display = 'flex';
            } else {
                // æ²’æœ‰éæœŸé …ç›®ï¼Œéš±è—è­¦å‘Š
                if (alertDiv) {
                    alertDiv.style.display = 'none';
                }
            }
        }
        
        // æ»¾å‹•åˆ°ç¬¬ä¸€å€‹éæœŸé …ç›®
        function scrollToFirstOverdue() {
            const overdueRow = document.querySelector('tr.overdue');
            if (overdueRow) {
                overdueRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // é«˜äº®æ•ˆæœ
                overdueRow.style.transition = 'all 0.3s';
                overdueRow.style.transform = 'scale(1.02)';
                overdueRow.style.boxShadow = '0 0 20px rgba(255, 68, 68, 0.5)';
                setTimeout(() => {
                    overdueRow.style.transform = '';
                    overdueRow.style.boxShadow = '';
                }, 1000);
            }
        }
        
        // æ·»åŠ éœ‡å‹•å‹•ç•«
        const shakeStyle = document.createElement('style');
        shakeStyle.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(shakeStyle);

        // æ¸…ç©ºå·²å®Œæˆé …ç›®
        function clearCompletedData() {
            const completedCount = todos.filter(t => t.completed).length;
            
            if (completedCount === 0) {
                alert('ç›®å‰æ²’æœ‰å·²å®Œæˆçš„é …ç›®ï¼');
                return;
            }
            
            const confirmation = confirm(`âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·²å®Œæˆé …ç›®å—ï¼Ÿ\n\né€™å°‡åˆªé™¤ ${completedCount} ç­†å·²å®Œæˆçš„å¾…è¾¦äº‹é …ã€‚`);
            
            if (confirmation) {
                saveToHistory();
                todos = todos.filter(t => !t.completed);
                saveTodos();
                updateStatistics();
                renderTodos();
                alert('âœ… å·²æ¸…ç©ºæ‰€æœ‰å·²å®Œæˆé …ç›®ï¼');
            }
        }

        // æ¸…ç©ºå¾…è¾¦é …ç›®
        function clearIncompleteData() {
            const incompleteCount = todos.filter(t => !t.completed).length;
            
            if (incompleteCount === 0) {
                alert('ç›®å‰æ²’æœ‰å¾…è¾¦é …ç›®ï¼');
                return;
            }
            
            const confirmation = confirm(`âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å¾…è¾¦é …ç›®å—ï¼Ÿ\n\né€™å°‡åˆªé™¤ ${incompleteCount} ç­†æœªå®Œæˆçš„å¾…è¾¦äº‹é …ã€‚\n\nå»ºè­°å…ˆåŒ¯å‡ºè³‡æ–™å‚™ä»½ã€‚`);
            
            if (confirmation) {
                saveToHistory();
                todos = todos.filter(t => t.completed);
                saveTodos();
                updateStatistics();
                renderTodos();
                alert('âœ… å·²æ¸…ç©ºæ‰€æœ‰å¾…è¾¦é …ç›®ï¼');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (todos.length === 0) {
                alert('ç›®å‰æ²’æœ‰ä»»ä½•è³‡æ–™ï¼');
                return;
            }
            
            const confirmation = confirm(`âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ\n\né€™å°‡åˆªé™¤æ‰€æœ‰ ${todos.length} ç­†å¾…è¾¦äº‹é …ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nå»ºè­°å…ˆåŒ¯å‡ºè³‡æ–™å‚™ä»½ã€‚`);
            
            if (confirmation) {
                const doubleCheck = confirm('çœŸçš„ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿé€™æ˜¯æœ€å¾Œç¢ºèªï¼');
                if (doubleCheck) {
                    saveToHistory();
                    todos = [];
                    saveTodos();
                    updateStatistics();
                    renderTodos();
                    alert('âœ… å·²æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼');
                }
            }
        }

        // æŒ‰Enterä¹Ÿå¯ä»¥æ–°å¢
        document.getElementById('todoInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        // åˆ‡æ›è‡ªè¨‚ç‹€æ…‹è¼¸å…¥æ¡†
        function toggleCustomStatusInput() {
            const statusInput = document.getElementById('statusInput');
            const customStatusGroup = document.getElementById('customStatusGroup');
            
            if (statusInput.value === 'custom') {
                customStatusGroup.style.display = 'block';
                document.getElementById('customStatusInput').focus();
            } else {
                customStatusGroup.style.display = 'none';
            }
        }

        function addTodo() {
            const todoInput = document.getElementById('todoInput');
            const categoryInput = document.getElementById('categoryInput');
            const priorityInput = document.getElementById('priorityInput');
            const dueDateManual = document.getElementById('dueDateManual');
            const dueInput = document.getElementById('dueInput');
            const combinepackInput = document.getElementById('combinepackInput');
            const statusInput = document.getElementById('statusInput');
            const customStatusInput = document.getElementById('customStatusInput');
            const remarkInput = document.getElementById('remarkInput');

            const name = todoInput.value.trim();
            const category = categoryInput.value;
            const priority = priorityInput.value;
            const combinepack = combinepackInput.value.trim();
            let status = statusInput.value;
            const remark = remarkInput.value.trim();
            const startDate = document.getElementById('startDateInput').value || '';
            const difficulty = document.getElementById('difficultyInput').value || '';
            
            // è™•ç†è‡ªè¨‚ç‹€æ…‹
            if (status === 'custom') {
                const customValue = customStatusInput.value.trim();
                if (customValue) {
                    status = 'custom:' + customValue;
                } else {
                    alert('è«‹è¼¸å…¥è‡ªè¨‚ç‹€æ…‹åç¨±ï¼');
                    return;
                }
            }
            
            // å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥ï¼Œå¦‚æœæ‰‹å‹•è¼¸å…¥ç‚ºç©ºå‰‡ä½¿ç”¨æ—¥æœŸé¸æ“‡å™¨
            let due = '';
            const manualDate = dueDateManual.value.trim();
            if (manualDate) {
                due = parseManualDate(manualDate);
                if (!due) {
                    alert('âŒ æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼\n\nè«‹ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š\n- MMDD (ä¾‹å¦‚ï¼š0115 = ä»Šå¹´1æœˆ15æ—¥)\n- M-DD (ä¾‹å¦‚ï¼š1-15 = ä»Šå¹´1æœˆ15æ—¥)\n- YYYYMMDD (ä¾‹å¦‚ï¼š20250115)\n- YYYY-MM-DD (ä¾‹å¦‚ï¼š2025-01-15)\n- YYYY/MM/DD (ä¾‹å¦‚ï¼š2025/01/15)\n\nğŸ’¡ æ²’æœ‰è¼¸å…¥å¹´ä»½æœƒè‡ªå‹•ä½¿ç”¨ä»Šå¹´ï¼');
                    return;
                }
            } else {
                due = dueInput.value;
            }

            if (name === '') {
                alert('è«‹è¼¸å…¥å¾…è¾¦äº‹é …åç¨±ï¼');
                return;
            }

            if (due === '') {
                alert('è«‹é¸æ“‡æˆ–è¼¸å…¥æˆªæ­¢æ—¥æœŸï¼');
                return;
            }

            // é©—è­‰æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
            const dateObj = new Date(due);
            if (isNaN(dateObj.getTime())) {
                alert('âŒ æ—¥æœŸç„¡æ•ˆï¼è«‹æª¢æŸ¥æ—¥æœŸæ ¼å¼ã€‚');
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            // å„²å­˜åˆ°æ­·å²è¨˜éŒ„
            saveToHistory();

            const todo = {
                id: Date.now(),
                name: name,
                completed: false,
                category: category,
                priority: priority,
                due: due,
                combinepack: combinepack || '',
                status: status || '',
                remark: remark || '',
                startDate: startDate || '',
                difficulty: difficulty || '',
                dateToday: today
            };

            todos.push(todo);
            saveTodos();
            updateStatistics();
            renderTodos();

            // æ¸…ç©ºè¼¸å…¥æ¬„
            todoInput.value = '';
            categoryInput.value = '';
            combinepackInput.value = '';
            statusInput.value = '';
            customStatusInput.value = '';
            document.getElementById('customStatusGroup').style.display = 'none';
            remarkInput.value = '';
            dueDateManual.value = '';
            dueInput.value = '';
            document.getElementById('startDateInput').value = '';
            document.getElementById('difficultyInput').value = '';
            todoInput.focus();
        }

        function toggleComplete(id) {
            saveToHistory();
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                saveTodos();
                updateStatistics();
                renderTodos();
            }
        }

        function deleteTodo(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å¾…è¾¦äº‹é …å—ï¼Ÿ')) {
                saveToHistory();
                todos = todos.filter(t => t.id !== id);
                saveTodos();
                updateStatistics();
                renderTodos();
            }
        }

        // å…¨é¸/å–æ¶ˆå…¨é¸
        function toggleSelectAll(checkbox) {
            const selectBoxes = document.querySelectorAll('.select-item');
            selectBoxes.forEach(box => {
                box.checked = checkbox.checked;
            });
            updateSelectCount();
        }

        // æ›´æ–°é¸å–è¨ˆæ•¸
        function updateSelectCount() {
            const selectBoxes = document.querySelectorAll('.select-item:checked');
            const count = selectBoxes.length;
            
            // å¯ä»¥åœ¨é€™è£¡é¡¯ç¤ºé¸å–æ•¸é‡
            console.log(`å·²é¸å– ${count} å€‹é …ç›®`);
        }

        // è¤‡è£½é¸å–çš„é …ç›®
        function copySelectedItems() {
            const selectBoxes = document.querySelectorAll('.select-item:checked');
            
            if (selectBoxes.length === 0) {
                alert('âŒ è«‹å…ˆå‹¾é¸è¦è¤‡è£½çš„é …ç›®ï¼');
                return;
            }

            const selectedIds = Array.from(selectBoxes).map(box => parseInt(box.dataset.todoId));
            const selectedTodos = todos.filter(t => selectedIds.includes(t.id));

            if (selectedTodos.length === 0) {
                alert('âŒ æ‰¾ä¸åˆ°é¸å–çš„é …ç›®ï¼');
                return;
            }

            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            const todosData = JSON.stringify(selectedTodos);
            localStorage.setItem('copiedTodos', todosData);
            
            // ä¹Ÿå­˜å–®å€‹é …ç›®æ ¼å¼ä»¥å…¼å®¹åŸæœ‰åŠŸèƒ½
            if (selectedTodos.length === 1) {
                localStorage.setItem('copiedTodo', JSON.stringify(selectedTodos[0]));
            }
            
            // é¡¯ç¤ºæç¤º
            showToast(`âœ… å·²è¤‡è£½ ${selectedTodos.length} å€‹é …ç›®ï¼å¯ä»¥æŒ‰ã€Œè²¼ä¸Šã€æŒ‰éˆ•è²¼ä¸Š`);
            
            // å–æ¶ˆå‹¾é¸
            selectBoxes.forEach(box => box.checked = false);
            const selectAllBox = document.getElementById('selectAll');
            if (selectAllBox) selectAllBox.checked = false;
        }

        // è¤‡è£½å¾…è¾¦äº‹é …
        function copyTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;
            
            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            const todoData = JSON.stringify(todo);
            localStorage.setItem('copiedTodo', todoData);
            
            // é¡¯ç¤ºæç¤º
            showToast('âœ… å·²è¤‡è£½ï¼å¯ä»¥åœ¨ä»»ä½•ä½ç½®è²¼ä¸Š');
        }

        // è²¼ä¸Šå¾…è¾¦äº‹é …
        function pasteTodo() {
            // å„ªå…ˆæª¢æŸ¥æ‰¹é‡è¤‡è£½
            const copiedTodosData = localStorage.getItem('copiedTodos');
            if (copiedTodosData) {
                try {
                    const copiedTodos = JSON.parse(copiedTodosData);
                    if (Array.isArray(copiedTodos) && copiedTodos.length > 0) {
                        saveToHistory();
                        
                        const today = new Date().toISOString().split('T')[0];
                        let baseTime = Date.now();
                        
                        copiedTodos.forEach((copiedTodo, index) => {
                            const newTodo = {
                                ...copiedTodo,
                                id: baseTime + index,
                                completed: false,
                                dateToday: today
                            };
                            todos.push(newTodo);
                        });
                        
                        saveTodos();
                        updateStatistics();
                        renderTodos();
                        
                        showToast(`âœ… å·²è²¼ä¸Š ${copiedTodos.length} å€‹é …ç›®ï¼`);
                        return;
                    }
                } catch (error) {
                    console.error('æ‰¹é‡è²¼ä¸Šå¤±æ•—ï¼š', error);
                }
            }
            
            // å–®å€‹é …ç›®è²¼ä¸Š
            const copiedData = localStorage.getItem('copiedTodo');
            if (!copiedData) {
                alert('âŒ æ²’æœ‰å¯è²¼ä¸Šçš„é …ç›®ï¼è«‹å…ˆè¤‡è£½é …ç›®ã€‚');
                return;
            }
            
            try {
                const copiedTodo = JSON.parse(copiedData);
                saveToHistory();
                
                // å»ºç«‹æ–°çš„é …ç›®ï¼ˆæ–°çš„ ID å’Œæ—¥æœŸï¼‰
                const newTodo = {
                    ...copiedTodo,
                    id: Date.now(),
                    completed: false,
                    dateToday: new Date().toISOString().split('T')[0]
                };
                
                todos.push(newTodo);
                saveTodos();
                updateStatistics();
                renderTodos();
                
                showToast('âœ… å·²è²¼ä¸Šï¼');
            } catch (error) {
                alert('âŒ è²¼ä¸Šå¤±æ•—ï¼è³‡æ–™æ ¼å¼éŒ¯èª¤ã€‚');
            }
        }

        // è¤‡è£½åˆ—è¡¨ï¼ˆæ•´æ‰¹è¤‡è£½ï¼‰
        function copySelectedTodos(ids) {
            const selectedTodos = todos.filter(t => ids.includes(t.id));
            if (selectedTodos.length === 0) return;
            
            localStorage.setItem('copiedTodos', JSON.stringify(selectedTodos));
            showToast(`âœ… å·²è¤‡è£½ ${selectedTodos.length} å€‹é …ç›®ï¼`);
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // æ·»åŠ å‹•ç•«æ¨£å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        function saveTodos() {
            localStorage.setItem('todos', JSON.stringify(todos));
        }

        // è¨­å®šæ’åºæ¨¡å¼
        function setSortMode(mode) {
            currentSortMode = mode;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.style.border = '2px solid #ccc';
                btn.style.background = 'white';
                btn.style.color = '#000';
            });
            
            // æ ¹æ“š mode æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ• ID
            const idMap = {
                'pack': 'sortPack',
                'due': 'sortDue',
                'balance': 'sortBalance',
                'priority': 'sortPriority',
                'category': 'sortCategory'
            };
            
            const activeBtn = document.getElementById(idMap[mode]);
            if (activeBtn) {
                activeBtn.style.border = '2px solid #667eea';
                activeBtn.style.background = '#667eea';
                activeBtn.style.color = 'white';
            }
            
            renderTodos();
        }

        // åˆ‡æ›å‡åº/é™åº
        function toggleSortOrder() {
            sortAscending = !sortAscending;
            const btn = document.getElementById('sortOrder');
            if (sortAscending) {
                btn.innerHTML = 'â–² å‡åº';
            } else {
                btn.innerHTML = 'â–¼ é™åº';
            }
            renderTodos();
        }

        // é€šç”¨æ’åºå‡½æ•¸
        function sortTodosByMode(todos) {
            return todos.sort((a, b) => {
                let comparison = 0;
                
                switch(currentSortMode) {
                    case 'due':
                        comparison = new Date(a.due) - new Date(b.due);
                        break;
                    case 'balance':
                        const todayDate = new Date();
                        todayDate.setHours(0, 0, 0, 0);
                        const aDate = new Date(a.due);
                        const bDate = new Date(b.due);
                        aDate.setHours(0, 0, 0, 0);
                        bDate.setHours(0, 0, 0, 0);
                        const aDiff = Math.ceil((aDate - todayDate) / (1000 * 60 * 60 * 24));
                        const bDiff = Math.ceil((bDate - todayDate) / (1000 * 60 * 60 * 24));
                        comparison = aDiff - bDiff;
                        break;
                    case 'priority':
                        const priorityOrder = { veryhigh: 0, high: 1, medium: 2, low: 3, verylow: 4 };
                        comparison = priorityOrder[a.priority] - priorityOrder[b.priority];
                        break;
                    case 'category':
                        const aCategory = a.category || '';
                        const bCategory = b.category || '';
                        comparison = aCategory.localeCompare(bCategory);
                        break;
                    case 'pack':
                    default:
                        // pack æ¨¡å¼åœ¨ renderTodos ä¸­ç‰¹åˆ¥è™•ç†
                        return 0;
                }
                
                return sortAscending ? comparison : -comparison;
            });
        }

        // æ‡‰ç”¨ç¯©é¸
        function applyFilters() {
            currentFilters.completed = document.getElementById('filterCompleted').value;
            currentFilters.priority = document.getElementById('filterPriority').value;
            currentFilters.status = document.getElementById('filterStatus').value;
            currentFilters.difficulty = document.getElementById('filterDifficulty').value;
            currentFilters.category = document.getElementById('filterCategory').value.toLowerCase().trim();
            currentFilters.pack = document.getElementById('filterPack').value.toLowerCase().trim();
            currentFilters.overdue = document.getElementById('filterOverdue').value;
            
            updateFilterCount();
            renderTodos();
        }
        
        // æ¸…é™¤æ‰€æœ‰ç¯©é¸
        function clearAllFilters() {
            document.getElementById('filterCompleted').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDifficulty').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterPack').value = '';
            document.getElementById('filterOverdue').value = '';
            
            currentFilters = {
                completed: '',
                priority: '',
                status: '',
                difficulty: '',
                category: '',
                pack: '',
                overdue: ''
            };
            
            updateFilterCount();
            renderTodos();
        }
        
        // æ›´æ–°ç¯©é¸è¨ˆæ•¸
        function updateFilterCount() {
            const activeFilters = Object.values(currentFilters).filter(v => v !== '').length;
            const countEl = document.getElementById('filterCount');
            if (activeFilters > 0) {
                countEl.textContent = `å·²å¥—ç”¨ ${activeFilters} å€‹ç¯©é¸æ¢ä»¶`;
                countEl.style.color = '#1976d2';
                countEl.style.fontWeight = '600';
            } else {
                countEl.textContent = 'æœªå¥—ç”¨ç¯©é¸';
                countEl.style.color = '#999';
                countEl.style.fontWeight = 'normal';
            }
        }
        
        // æª¢æŸ¥é …ç›®æ˜¯å¦ç¬¦åˆç¯©é¸æ¢ä»¶
        function matchesFilters(todo, today) {
            // å®Œæˆç‹€æ…‹ç¯©é¸
            if (currentFilters.completed !== '') {
                const isCompleted = currentFilters.completed === 'true';
                if (todo.completed !== isCompleted) return false;
            }
            
            // å„ªå…ˆç´šç¯©é¸
            if (currentFilters.priority !== '' && todo.priority !== currentFilters.priority) {
                return false;
            }
            
            // ç‹€æ…‹ç¯©é¸
            if (currentFilters.status !== '') {
                if (todo.status !== currentFilters.status && 
                    !todo.status?.startsWith('custom:' + currentFilters.status)) {
                    return false;
                }
            }
            
            // å›°é›£åº¦ç¯©é¸
            if (currentFilters.difficulty !== '' && todo.difficulty !== currentFilters.difficulty) {
                return false;
            }
            
            // åˆ†é¡ç¯©é¸
            if (currentFilters.category !== '') {
                if (!todo.category || !todo.category.toLowerCase().includes(currentFilters.category)) {
                    return false;
                }
            }
            
            // Pack ç¯©é¸
            if (currentFilters.pack !== '') {
                if (!todo.combinepack || !todo.combinepack.toLowerCase().includes(currentFilters.pack)) {
                    return false;
                }
            }
            
            // éæœŸç‹€æ…‹ç¯©é¸
            if (currentFilters.overdue !== '') {
                const dueDate = new Date(todo.due);
                dueDate.setHours(0, 0, 0, 0);
                const isOverdue = !todo.completed && dueDate < today;
                const shouldShowOverdue = currentFilters.overdue === 'true';
                if (isOverdue !== shouldShowOverdue) return false;
            }
            
            return true;
        }

        function renderTodos() {
            const todoList = document.getElementById('todoList');
            
            if (todos.length === 0) {
                todoList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/>
                        </svg>
                        <p>é‚„æ²’æœ‰å¾…è¾¦äº‹é …ï¼Œé–‹å§‹æ–°å¢ä¸€å€‹å§ï¼</p>
                    </div>
                `;
                return;
            }

            // åˆ†é›¢æœªå®Œæˆå’Œå·²å®Œæˆçš„é …ç›®ï¼Œä¸¦æ‡‰ç”¨ç¯©é¸
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const filteredTodos = todos.filter(t => matchesFilters(t, today));
            const incompleteTodos = filteredTodos.filter(t => !t.completed);
            const completedTodos = filteredTodos.filter(t => t.completed);
            
            // å¦‚æœç¯©é¸å¾Œæ²’æœ‰é …ç›®
            if (filteredTodos.length === 0) {
                todoList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/>
                        </svg>
                        <p>æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®</p>
                        <button onclick="clearAllFilters()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            æ¸…é™¤ç¯©é¸
                        </button>
                    </div>
                `;
                return;
            }

            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);

            let html = '<table class="todo-table"><thead><tr>';
            html += '<th style="width: 35px; min-width: 35px; font-size: 12px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" style="width: 16px; height: 16px; cursor: pointer;" title="å…¨é¸/å–æ¶ˆå…¨é¸" /></th>';
            html += '<th style="width: 40px; min-width: 40px; font-size: 12px;">âœ“</th>';
            html += '<th style="min-width: 120px; max-width: 180px; font-size: 12px;">å¾…è¾¦äº‹é …</th>';
            html += '<th style="width: 80px; min-width: 80px; font-size: 11px;">Category</th>';
            html += '<th style="width: 85px; min-width: 85px; font-size: 11px;">Priority</th>';
            html += '<th style="width: 80px; min-width: 80px; font-size: 11px;">Status</th>';
            html += '<th style="width: 90px; min-width: 90px; font-size: 11px;">Due Date</th>';
            html += '<th style="width: 70px; min-width: 70px; font-size: 11px;">Balance</th>';
            html += '<th style="width: 90px; min-width: 90px; font-size: 11px;">é–‹å§‹æ—¥æœŸ</th>';
            html += '<th style="width: 70px; min-width: 70px; font-size: 11px;">é€±æœŸ</th>';
            html += '<th style="width: 75px; min-width: 75px; font-size: 11px;">é›£åº¦</th>';
            html += '<th style="width: 90px; min-width: 90px; font-size: 11px;">Pack</th>';
            html += '<th style="width: 120px; min-width: 120px; font-size: 11px;">Remark</th>';
            html += '<th style="width: 100px; min-width: 100px; font-size: 11px;">æ“ä½œ</th>';
            html += '</tr></thead><tbody>';

            // æ ¹æ“šæ’åºæ¨¡å¼æ¸²æŸ“
            if (currentSortMode === 'pack') {
                // Pack æ¨¡å¼ï¼šæŒ‰çµ„åˆ¥åˆ†çµ„ï¼ˆåŒ…å«å·²å®Œæˆé …ç›®ä¾†è¨ˆç®—ç™¾åˆ†æ¯”ï¼‰
                const groupedByPack = {};
                const noPack = [];
                
                // å…ˆç”¨æ‰€æœ‰é …ç›®ï¼ˆåŒ…æ‹¬å·²å®Œæˆï¼‰ä¾†åˆ†çµ„è¨ˆç®—ç™¾åˆ†æ¯”
                const allGroupedByPack = {};
                todos.forEach(todo => {
                    if (todo.combinepack && todo.combinepack.trim() !== '') {
                        if (!allGroupedByPack[todo.combinepack]) {
                            allGroupedByPack[todo.combinepack] = [];
                        }
                        allGroupedByPack[todo.combinepack].push(todo);
                    }
                });
                
                // åªç”¨æœªå®Œæˆé …ç›®ä¾†é¡¯ç¤º
                incompleteTodos.forEach(todo => {
                    if (todo.combinepack && todo.combinepack.trim() !== '') {
                        if (!groupedByPack[todo.combinepack]) {
                            groupedByPack[todo.combinepack] = [];
                        }
                        groupedByPack[todo.combinepack].push(todo);
                    } else {
                        noPack.push(todo);
                    }
                });

                // å°æ¯å€‹çµ„å…§çš„é …ç›®æ’åºï¼ˆå„ªå…ˆæŒ‰æ—¥æœŸï¼‰
                const sortTodosInGroup = (todos) => {
                    return todos.sort((a, b) => {
                        const dateDiff = new Date(a.due) - new Date(b.due);
                        if (dateDiff !== 0) return dateDiff;
                        const priorityOrder = { veryhigh: 0, high: 1, medium: 2, low: 3, verylow: 4 };
                        return priorityOrder[a.priority] - priorityOrder[b.priority];
                    });
                };

                const sortedNoPack = sortTodosInGroup(noPack);

                // è¨ˆç®—æ¯å€‹ Pack çš„æœ€æ—©åˆ°æœŸæ—¥ï¼Œä¸¦æ’åº Pack
                const packWithEarliestDate = [];
                Object.keys(groupedByPack).forEach(packName => {
                    const packTodos = groupedByPack[packName];
                    const earliestDate = Math.min(...packTodos.map(t => new Date(t.due).getTime()));
                    packWithEarliestDate.push({ packName, earliestDate });
                });
                
                packWithEarliestDate.sort((a, b) => a.earliestDate - b.earliestDate);
                const sortedPackNames = packWithEarliestDate.map(p => p.packName);

                // æ¸²æŸ“æœ‰ pack çš„é …ç›®
                sortedPackNames.forEach(packName => {
                    const packTodos = sortTodosInGroup(groupedByPack[packName]);
                    
                    // ä½¿ç”¨æ‰€æœ‰é …ç›®ï¼ˆåŒ…æ‹¬å·²å®Œæˆï¼‰ä¾†è¨ˆç®—ç™¾åˆ†æ¯”
                    const allPackTodos = allGroupedByPack[packName] || [];
                    const completedCount = allPackTodos.filter(t => t.completed).length;
                    const totalCount = allPackTodos.length;
                    const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                    
                    const earliestDue = packTodos.reduce((earliest, todo) => {
                        const todoDate = new Date(todo.due);
                        return todoDate < earliest ? todoDate : earliest;
                    }, new Date(packTodos[0].due));
                    const earliestDueStr = formatDate(earliestDue.toISOString().split('T')[0]);
                    
                    html += `<tr class="pack-header-row">`;
                    html += `<td colspan="14" style="padding: 12px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; font-size: 15px;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
                    html += `<span>ğŸ“¦ ${packName} <span style="font-size: 13px; font-weight: normal;">ï¼ˆæœ€æ—©ï¼š${earliestDueStr}ï¼‰</span></span>`;
                    html += `<span style="font-size: 13px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px;">${completedCount}/${totalCount} å®Œæˆ (${progress}%)</span>`;
                    html += `</div>`;
                    html += `</td>`;
                    html += `</tr>`;
                    
                    packTodos.forEach(todo => {
                        html += renderTodoRow(todo, today, true);
                    });
                });

                // æ¸²æŸ“ç„¡ pack çš„é …ç›®
                if (sortedNoPack.length > 0) {
                    if (sortedPackNames.length > 0) {
                        html += `<tr class="divider-row">`;
                        html += `<td colspan="14" style="padding: 10px 15px; background: #f0f0f0; color: #000; font-weight: 500; font-size: 14px;">å…¶ä»–å¾…è¾¦äº‹é …</td>`;
                        html += `</tr>`;
                    }
                    
                    sortedNoPack.forEach(todo => {
                        html += renderTodoRow(todo, today, false);
                    });
                }
            } else {
                // å…¶ä»–æ’åºæ¨¡å¼ï¼šç›´æ¥æ’åºæ•´å€‹åˆ—è¡¨
                const sortedIncompleteTodos = sortTodosByMode([...incompleteTodos]);
                
                sortedIncompleteTodos.forEach(todo => {
                    html += renderTodoRow(todo, today, false);
                });
            }

            html += '</tbody></table>';

            // å·²å®Œæˆé …ç›®å€åŸŸ
            if (completedTodos.length > 0) {
                html += `
                    <div class="completed-section">
                        <div class="completed-header" onclick="toggleCompleted()">
                            <span id="completedToggleIcon">â–¶</span>
                            <span>å·²å®Œæˆ (${completedTodos.length})</span>
                        </div>
                        <div id="completedList" style="display: none;">
                            <table class="todo-table"><thead><tr>
                                <th style="width: 50px; min-width: 50px; font-size: 14px;">âœ“</th>
                                <th style="min-width: 150px; font-size: 14px;">å¾…è¾¦äº‹é …</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">Category</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">Priority</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">Status</th>
                                <th style="width: 140px; min-width: 140px; font-size: 14px;">Due Date</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">Balance</th>
                                <th style="width: 150px; min-width: 150px; font-size: 14px;">Pack</th>
                                <th style="width: 200px; min-width: 200px; font-size: 14px;">Remark</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">æ“ä½œ</th>
                            </tr></thead><tbody>
                `;

                // å·²å®Œæˆé …ç›®ä¹ŸæŒ‰ pack åˆ†çµ„
                const completedGrouped = {};
                const completedNoPack = [];
                
                completedTodos.forEach(todo => {
                    if (todo.combinepack && todo.combinepack.trim() !== '') {
                        if (!completedGrouped[todo.combinepack]) {
                            completedGrouped[todo.combinepack] = [];
                        }
                        completedGrouped[todo.combinepack].push(todo);
                    } else {
                        completedNoPack.push(todo);
                    }
                });

                // æ¸²æŸ“å·²å®Œæˆçš„ pack é …ç›®
                Object.keys(completedGrouped).sort().forEach(packName => {
                    const packTodos = completedGrouped[packName];
                    html += `<tr class="pack-header-row" style="opacity: 0.7;">`;
                    html += `<td colspan="14" style="padding: 10px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; font-size: 14px;">ğŸ“¦ ${packName}</td>`;
                    html += `</tr>`;
                    
                    packTodos.forEach(todo => {
                        html += renderTodoRow(todo, today, true);
                    });
                });

                // æ¸²æŸ“å·²å®Œæˆçš„ç„¡ pack é …ç›®
                completedNoPack.forEach(todo => {
                    html += renderTodoRow(todo, today, false);
                });

                html += '</tbody></table></div></div>';
            }

            todoList.innerHTML = html;
        }

        function renderTodoRow(todo, today, inPack) {
            const dueDate = new Date(todo.due);
            const isOverdue = !todo.completed && dueDate < today;
            const formattedDue = formatDate(todo.due);
            const balance = calculateBalance(todo.due, todo.completed);

            const priorityText = {
                veryhigh: 'éå¸¸ç·Šæ€¥!!',
                high: 'ç·Šæ€¥',
                medium: 'æ™®é€š',
                low: 'ä¸æ€¥',
                verylow: 'éå¸¸ä¸æ€¥'
            }[todo.priority];

            const statusText = {
                notstarted: 'å°šæœªé–‹å§‹',
                inprogress: 'é€²è¡Œä¸­',
                pending: 'ç­‰å¾…ä¸­',
                blocked: 'å—é˜»',
                completed: 'å·²å®Œæˆ'
            }[todo.status] || (todo.status && todo.status.startsWith('custom:') ? todo.status.substring(7) : '-');

            const rowClass = `${todo.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''} priority-${todo.priority} ${inPack ? 'in-pack' : ''}`;

            let html = `<tr data-todo-id="${todo.id}" class="${rowClass}">`;
            
            // Select checkbox (for batch operations)
            html += `<td style="font-size: 12px; text-align: center;">`;
            html += `<input type="checkbox" class="select-item" data-todo-id="${todo.id}" style="width: 16px; height: 16px; cursor: pointer;" onclick="event.stopPropagation()" />`;
            html += `</td>`;
            
            // Complete checkbox with overdue alert
            html += `<td style="font-size: 12px; position: relative;">`;
            if (isOverdue) {
                html += `<span style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); font-size: 20px; animation: pulse 10s infinite; filter: drop-shadow(0 0 3px rgba(204, 0, 0, 0.8));" title="å·²éæœŸï¼">âš ï¸</span>`;
            }
            html += `<input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleComplete(${todo.id})" style="width: 18px; height: 18px; cursor: pointer; ${isOverdue ? 'margin-left: 32px;' : ''}" />`;
            html += `</td>`;
            
            // å¾…è¾¦äº‹é …åç¨± - å¯ç·¨è¼¯
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'name', this)" style="font-size: 12px;">${todo.name}</td>`;
            
            // Category - å¯ç·¨è¼¯
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'category', this)" style="font-size: 12px;">${todo.category || '-'}</td>`;
            
            // Priority - å¯ç·¨è¼¯
            html += `<td class="editable-cell" onclick="editPriority(${todo.id}, this, event)" style="font-size: 12px;"><span class="priority-badge priority-${todo.priority}">${priorityText}</span></td>`;
            
            // Status - å¯ç·¨è¼¯
            html += `<td class="editable-cell" onclick="editStatus(${todo.id}, this, event)" style="font-size: 12px;">`;
            if (todo.status) {
                html += `<span class="status-badge status-${todo.status}">${statusText}</span>`;
            } else {
                html += '-';
            }
            html += `</td>`;
            
            // Due Date - å¯ç·¨è¼¯
            html += `<td class="editable-cell ${isOverdue ? 'overdue-text' : ''}" onclick="editField(${todo.id}, 'due', this)" style="font-size: 12px;">
                        ğŸ“… ${formattedDue}${isOverdue ? ' (é€¾æœŸ)' : ''}
                    </td>`;
            
            // Balance - å‰©é¤˜å¤©æ•¸ï¼ˆä¸å¯ç·¨è¼¯ï¼‰
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);
            const balanceDueDate = new Date(todo.due);
            balanceDueDate.setHours(0, 0, 0, 0);
            const diffTime = balanceDueDate - todayDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let balanceStyle = 'font-size: 14px; font-weight: 600;';
            if (!todo.completed) {
                if (diffDays < 0) {
                    balanceStyle += ' color: #dc3545;'; // ç´…è‰² - é€¾æœŸ
                } else if (diffDays === 0) {
                    balanceStyle += ' color: #ff6b00;'; // æ©˜è‰² - ä»Šå¤©
                } else if (diffDays <= 3) {
                    balanceStyle += ' color: #ffc107;'; // é»ƒè‰² - 3å¤©å…§
                } else {
                    balanceStyle += ' color: #28a745;'; // ç¶ è‰² - å……è¶³æ™‚é–“
                }
            }
            
            html += `<td style="${balanceStyle}">${balance}</td>`;
            
            // é–‹å§‹æ—¥æœŸ - å¯ç·¨è¼¯
            const formattedStartDate = todo.startDate ? formatDate(todo.startDate) : '-';
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'startDate', this)" style="font-size: 12px;">
                        ${todo.startDate ? 'ğŸ“… ' + formattedStartDate : '-'}
                    </td>`;
            
            // è™•ç†é€±æœŸ - å¾é–‹å§‹æ—¥æœŸåˆ° Due Date çš„å¤©æ•¸
            let duration = '-';
            if (todo.startDate && todo.due) {
                const start = new Date(todo.startDate);
                start.setHours(0, 0, 0, 0);
                
                const end = new Date(todo.due);
                end.setHours(0, 0, 0, 0);
                
                const durationDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                
                if (durationDays >= 0) {
                    duration = `${durationDays} å¤©`;
                } else {
                    // å¦‚æœé–‹å§‹æ—¥æœŸæ™šæ–¼åˆ°æœŸæ—¥ï¼ˆè² æ•¸ï¼‰
                    duration = `${durationDays} å¤©`;
                }
            } else if (todo.startDate) {
                // åªæœ‰é–‹å§‹æ—¥æœŸæ²’æœ‰ Due Date
                duration = 'éœ€è¨­å®šåˆ°æœŸæ—¥';
            }
            html += `<td style="font-size: 12px; font-weight: 500;" title="å¾é–‹å§‹æ—¥æœŸåˆ°åˆ°æœŸæ—¥çš„å¤©æ•¸">${duration}</td>`;
            
            // å›°é›£åº¦ - å¯ç·¨è¼¯
            const difficultyInfo = {
                veryeasy: { text: 'éå¸¸ç°¡å–®', icon: 'ğŸ˜Š' },
                easy: { text: 'ç°¡å–®', icon: 'ğŸ™‚' },
                medium: { text: 'æ™®é€š', icon: 'ğŸ˜' },
                hard: { text: 'å›°é›£', icon: 'ğŸ˜°' },
                veryhard: { text: 'éå¸¸å›°é›£', icon: 'ğŸ˜±' }
            };
            const diff = difficultyInfo[todo.difficulty] || null;
            html += `<td class="editable-cell" onclick="editDifficulty(${todo.id}, this, event)" style="font-size: 12px;">
                        ${diff ? `${diff.icon} ${diff.text}` : '-'}
                    </td>`;
            
            // Combine Pack - å¯ç·¨è¼¯
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'combinepack', this)" style="font-size: 12px;">${todo.combinepack || '-'}</td>`;
            
            // Remark - å¯ç·¨è¼¯ï¼ˆå…è¨±æ›è¡Œï¼‰
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'remark', this)" style="font-size: 12px; word-wrap: break-word; word-break: break-word;">${todo.remark || '-'}</td>`;
            
            // æ“ä½œ
            html += `<td style="font-size: 12px; position: relative;">`;
            if (isOverdue) {
                html += `<span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 20px; animation: pulse 10s infinite; filter: drop-shadow(0 0 3px rgba(204, 0, 0, 0.8));" title="å·²éæœŸï¼">âš ï¸</span>`;
            }
            html += `
                <button onclick="copyTodo(${todo.id})" style="padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 3px;" title="è¤‡è£½">ğŸ“‹</button>
                <button class="delete-btn" onclick="deleteTodo(${todo.id})" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="åˆªé™¤">ğŸ—‘ï¸</button>
            </td>`;
            
            html += '</tr>';
            return html;
        }

        // ç·¨è¼¯æ¬„ä½
        function editField(id, field, cell) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            const currentValue = todo[field] || '';
            const isDateField = field === 'due' || field === 'startDate';

            if (isDateField) {
                // æ—¥æœŸæ¬„ä½æä¾›æ‰‹å‹•è¼¸å…¥å’Œæ—¥æœŸé¸æ“‡å™¨
                const inputId = `edit-${id}-${field}`;
                cell.innerHTML = `
                    <div style="display: flex; gap: 3px; flex-direction: column;">
                        <input type="text" id="${inputId}-manual" class="edit-input" value="${currentValue}" 
                               placeholder="YYYYMMDDæˆ–YYYY-MM-DD" 
                               style="font-size: 12px; padding: 4px;" />
                        <input type="date" id="${inputId}-picker" class="edit-input" value="${currentValue}" 
                               style="font-size: 12px; padding: 4px;" />
                    </div>
                `;
                
                const manualInput = document.getElementById(`${inputId}-manual`);
                const pickerInput = document.getElementById(`${inputId}-picker`);
                
                // åŒæ­¥å…©å€‹è¼¸å…¥æ¡†
                manualInput.addEventListener('input', function() {
                    const parsed = parseManualDate(this.value);
                    if (parsed) pickerInput.value = parsed;
                });
                
                pickerInput.addEventListener('change', function() {
                    manualInput.value = this.value;
                });
                
                // å¤±ç„¦æ™‚å„²å­˜
                const saveFunc = function() {
                    let finalValue = manualInput.value.trim();
                    if (finalValue) {
                        finalValue = parseManualDate(finalValue);
                        if (!finalValue) {
                            alert('æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼');
                            manualInput.focus();
                            return;
                        }
                    } else {
                        finalValue = pickerInput.value;
                    }
                    if (finalValue) {
                        saveField(id, field, finalValue);
                    } else {
                        renderTodos();
                    }
                };
                
                manualInput.addEventListener('blur', saveFunc);
                pickerInput.addEventListener('blur', saveFunc);
                manualInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') this.blur();
                });
                
                manualInput.focus();
            } else {
                cell.innerHTML = `<input type="text" class="edit-input" value="${currentValue}" onblur="saveField(${id}, '${field}', this.value)" onkeypress="if(event.key==='Enter') this.blur()" autofocus />`;
                cell.querySelector('input').focus();
            }
        }

        // ç·¨è¼¯å„ªå…ˆç´š
        function editPriority(id, cell, event) {
            if (event) event.stopPropagation();
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            cell.innerHTML = `
                <select class="edit-select" onchange="saveField(${id}, 'priority', this.value)" onclick="event.stopPropagation()" autofocus>
                    <option value="veryhigh" ${todo.priority === 'veryhigh' ? 'selected' : ''}>éå¸¸ç·Šæ€¥!!</option>
                    <option value="high" ${todo.priority === 'high' ? 'selected' : ''}>ç·Šæ€¥</option>
                    <option value="medium" ${todo.priority === 'medium' ? 'selected' : ''}>æ™®é€š</option>
                    <option value="low" ${todo.priority === 'low' ? 'selected' : ''}>ä¸æ€¥</option>
                    <option value="verylow" ${todo.priority === 'verylow' ? 'selected' : ''}>éå¸¸ä¸æ€¥</option>
                </select>
            `;
            const select = cell.querySelector('select');
            select.focus();
            select.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // ç·¨è¼¯ç‹€æ…‹
        function editStatus(id, cell, event) {
            if (event) event.stopPropagation();
            const todo = todos.find(t => t.id === id);
            if (!todo) return;
            
            const customStatus = todo.status && todo.status.startsWith('custom:') ? todo.status.substring(7) : '';

            cell.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <select class="edit-select" id="statusSelect_${id}" onchange="handleStatusChange(${id}, this.value)" onclick="event.stopPropagation()" autofocus>
                        <option value="">æœªè¨­å®š</option>
                        <option value="notstarted" ${todo.status === 'notstarted' ? 'selected' : ''}>å°šæœªé–‹å§‹</option>
                        <option value="inprogress" ${todo.status === 'inprogress' ? 'selected' : ''}>é€²è¡Œä¸­</option>
                        <option value="pending" ${todo.status === 'pending' ? 'selected' : ''}>ç­‰å¾…ä¸­</option>
                        <option value="blocked" ${todo.status === 'blocked' ? 'selected' : ''}>å—é˜»</option>
                        <option value="completed" ${todo.status === 'completed' ? 'selected' : ''}>å·²å®Œæˆ</option>
                        <option value="custom" ${todo.status && todo.status.startsWith('custom:') ? 'selected' : ''}>å…¶ä»–...</option>
                    </select>
                    <input type="text" 
                           id="customStatusInput_${id}" 
                           class="edit-input" 
                           placeholder="è¼¸å…¥è‡ªè¨‚ç‹€æ…‹"
                           value="${customStatus}"
                           style="display: ${todo.status && todo.status.startsWith('custom:') ? 'block' : 'none'}; padding: 8px; border: 2px solid #667eea; border-radius: 4px; font-size: 14px;"
                           onblur="saveCustomStatus(${id})"
                           onkeypress="if(event.key==='Enter') saveCustomStatus(${id})"
                           onclick="event.stopPropagation()">
                </div>
            `;
            const select = cell.querySelector('select');
            select.focus();
            select.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // è™•ç†ç‹€æ…‹è®Šæ›´
        function handleStatusChange(id, value) {
            const customInput = document.getElementById(`customStatusInput_${id}`);
            
            if (value === 'custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                saveField(id, 'status', value);
            }
        }

        // å„²å­˜è‡ªè¨‚ç‹€æ…‹
        function saveCustomStatus(id) {
            const input = document.getElementById(`customStatusInput_${id}`);
            const customValue = input.value.trim();
            
            if (customValue) {
                saveField(id, 'status', 'custom:' + customValue);
            } else {
                saveField(id, 'status', '');
            }
        }

        // ç·¨è¼¯å›°é›£åº¦
        function editDifficulty(id, cell, event) {
            if (event) event.stopPropagation();
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            cell.innerHTML = `
                <select class="edit-select" onchange="saveField(${id}, 'difficulty', this.value)" onclick="event.stopPropagation()" autofocus>
                    <option value="">æœªè¨­å®š</option>
                    <option value="veryeasy" ${todo.difficulty === 'veryeasy' ? 'selected' : ''}>ğŸ˜Š éå¸¸ç°¡å–®</option>
                    <option value="easy" ${todo.difficulty === 'easy' ? 'selected' : ''}>ğŸ™‚ ç°¡å–®</option>
                    <option value="medium" ${todo.difficulty === 'medium' ? 'selected' : ''}>ğŸ˜ æ™®é€š</option>
                    <option value="hard" ${todo.difficulty === 'hard' ? 'selected' : ''}>ğŸ˜° å›°é›£</option>
                    <option value="veryhard" ${todo.difficulty === 'veryhard' ? 'selected' : ''}>ğŸ˜± éå¸¸å›°é›£</option>
                </select>
            `;
            const select = cell.querySelector('select');
            select.focus();
            select.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // å„²å­˜æ¬„ä½
        function saveField(id, field, value) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            if (field === 'name' && !value.trim()) {
                alert('å¾…è¾¦äº‹é …åç¨±ä¸èƒ½ç©ºç™½ï¼');
                renderTodos();
                return;
            }

            if (field === 'due' && !value) {
                alert('æˆªæ­¢æ—¥æœŸä¸èƒ½ç©ºç™½ï¼');
                renderTodos();
                return;
            }

            saveToHistory();
            todo[field] = value;
            saveTodos();
            updateStatistics();
            renderTodos();
        }

        function toggleCompleted() {
            const completedList = document.getElementById('completedList');
            const icon = document.getElementById('completedToggleIcon');
            if (completedList.style.display === 'none') {
                completedList.style.display = 'block';
                icon.textContent = 'â–¼';
            } else {
                completedList.style.display = 'none';
                icon.textContent = 'â–¶';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        function calculateBalance(dueDate, isCompleted) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (isCompleted) {
                return 'âœ… å·²å®Œæˆ';
            } else if (diffDays < 0) {
                return `â° é€¾æœŸ ${Math.abs(diffDays)} å¤©`;
            } else if (diffDays === 0) {
                return 'ğŸ”¥ ä»Šå¤©åˆ°æœŸ';
            } else {
                return `â³ å‰©é¤˜ ${diffDays} å¤©`;
            }
        }

        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            // åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ï¼ŒåŒ…å«æ¨™é¡Œå’Œè¨­å®š
            const allData = {
                version: '2.8',
                exportDate: new Date().toISOString(),
                customTitle: localStorage.getItem('customTitle') || 'ğŸ“ å¾…è¾¦äº‹é …æ¸…å–® v2025.01',
                todos: todos,
                settings: {
                    // å¯ä»¥åœ¨é€™è£¡åŠ å…¥å…¶ä»–è¨­å®š
                }
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const today = new Date().toISOString().split('T')[0];
            link.download = `todo-list-complete-backup-${today}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('âœ… å®Œæ•´è³‡æ–™å·²åŒ¯å‡ºï¼åŒ…å«æ¨™é¡Œã€å¾…è¾¦äº‹é …å’Œæ‰€æœ‰è¨­å®šã€‚å¯å„²å­˜åˆ°é›²ç«¯ç¡¬ç¢ŸåŒæ­¥åˆ°å…¶ä»–è£ç½®ã€‚');
        }

        // åŒ¯å…¥è³‡æ–™
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°æ ¼å¼ï¼ˆå®Œæ•´å‚™ä»½ï¼‰
                    if (importedData.version && importedData.todos) {
                        const confirmation = confirm(
                            `ç¢ºå®šè¦åŒ¯å…¥å®Œæ•´è³‡æ–™å—ï¼Ÿ\n\n` +
                            `â€¢ å¾…è¾¦äº‹é …ï¼š${importedData.todos.length} ç­†\n` +
                            `â€¢ æ¨™é¡Œï¼š${importedData.customTitle || 'é è¨­æ¨™é¡Œ'}\n` +
                            `â€¢ åŒ¯å‡ºæ—¥æœŸï¼š${importedData.exportDate ? new Date(importedData.exportDate).toLocaleString('zh-TW') : 'æœªçŸ¥'}\n\n` +
                            `é€™æœƒè¦†è“‹ç›®å‰æ‰€æœ‰è³‡æ–™ï¼`
                        );
                        
                        if (confirmation) {
                            // åŒ¯å…¥æ¨™é¡Œ
                            if (importedData.customTitle) {
                                localStorage.setItem('customTitle', importedData.customTitle);
                                document.getElementById('mainTitle').innerHTML = importedData.customTitle;
                            }
                            
                            // åŒ¯å…¥å¾…è¾¦äº‹é …
                            todos = importedData.todos;
                            saveTodos();
                            updateStatistics();
                            renderTodos();
                            
                            showToast('âœ… å®Œæ•´è³‡æ–™åŒ¯å…¥æˆåŠŸï¼åŒ…å«æ¨™é¡Œå’Œæ‰€æœ‰å¾…è¾¦äº‹é …ã€‚');
                        }
                    }
                    // èˆŠæ ¼å¼ï¼ˆåªæœ‰ todos é™£åˆ—ï¼‰
                    else if (Array.isArray(importedData)) {
                        const confirmation = confirm(`ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿ\n\né€™æœƒè¦†è“‹ç›®å‰çš„ ${todos.length} ç­†è³‡æ–™ï¼Œ\nåŒ¯å…¥ ${importedData.length} ç­†æ–°è³‡æ–™ã€‚`);
                        
                        if (confirmation) {
                            todos = importedData;
                            saveTodos();
                            updateStatistics();
                            renderTodos();
                            showToast('âœ… è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                        }
                    } else {
                        alert('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼');
                        return;
                    }
                } catch (error) {
                    alert('âŒ æª”æ¡ˆè®€å–å¤±æ•—ï¼è«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚\néŒ¯èª¤ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            
            // é‡ç½® file input
            event.target.value = '';
        }

        // ==================== åˆå§‹åŒ– ====================
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        loadTitle(); // è¼‰å…¥è‡ªè¨‚æ¨™é¡Œ
        updateCurrentDate();
        setInterval(updateCurrentDate, 1000); // æ¯ç§’æ›´æ–°æ™‚é–“
        updateStatistics();
        updateUndoButton();
        updateFilterCount(); // åˆå§‹åŒ–ç¯©é¸è¨ˆæ•¸
        renderTodos();

        // åŒæ­¥æ‰‹å‹•è¼¸å…¥å’Œæ—¥æœŸé¸æ“‡å™¨
        document.getElementById('dueDateManual').addEventListener('input', function(e) {
            const value = e.target.value.trim();
            const formatted = parseManualDate(value);
            if (formatted) {
                document.getElementById('dueInput').value = formatted;
            }
        });

        document.getElementById('dueInput').addEventListener('change', function(e) {
            document.getElementById('dueDateManual').value = e.target.value;
        });

        // ========== è¤‡è£½è²¼ä¸ŠåŠŸèƒ½å¢å¼· ==========
        
        // 1. æ”¯æ´è¡¨æ ¼å…§æ–‡å­—é¸å–å’Œè¤‡è£½åˆ°å¤–éƒ¨ï¼ˆExcelã€Word ç­‰ï¼‰
        document.addEventListener('copy', function(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString();
            
            if (selectedText) {
                // å…è¨±æ­£å¸¸çš„æ–‡å­—è¤‡è£½
                e.clipboardData.setData('text/plain', selectedText);
                
                // å¦‚æœé¸å–çš„æ˜¯è¡¨æ ¼å…§å®¹ï¼Œä¹Ÿæä¾› HTML æ ¼å¼ï¼ˆå¯è²¼åˆ° Excelï¼‰
                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;
                
                // æª¢æŸ¥æ˜¯å¦åœ¨è¡¨æ ¼å…§
                let tableElement = container.nodeType === 3 ? container.parentElement : container;
                while (tableElement && tableElement.tagName !== 'TABLE') {
                    tableElement = tableElement.parentElement;
                    if (tableElement === document.body) {
                        tableElement = null;
                        break;
                    }
                }
                
                if (tableElement) {
                    // åœ¨è¡¨æ ¼å…§ï¼Œæä¾› HTML æ ¼å¼ä»¥ä¾¿è²¼åˆ° Excel
                    const div = document.createElement('div');
                    div.appendChild(range.cloneContents());
                    e.clipboardData.setData('text/html', div.innerHTML);
                }
                
                e.preventDefault();
                showToast('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            }
        });

        // 2. æ”¯æ´ Ctrl+C/Cmd+C å¿«é€Ÿè¤‡è£½æ•´è¡Œ
        let lastClickedTodoId = null;
        
        document.addEventListener('click', function(e) {
            const row = e.target.closest('tr');
            if (row && row.dataset.todoId) {
                lastClickedTodoId = parseInt(row.dataset.todoId);
            }
        });

        document.addEventListener('keydown', function(e) {
            // Ctrl+C æˆ– Cmd+Cï¼ˆMacï¼‰
            if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                // å¦‚æœæ²’æœ‰é¸å–æ–‡å­—ï¼Œå‰‡è¤‡è£½æ•´å€‹å¾…è¾¦äº‹é …
                const selection = window.getSelection();
                if (!selection.toString() && lastClickedTodoId) {
                    e.preventDefault();
                    copyTodo(lastClickedTodoId);
                }
            }
            
            // Ctrl+V æˆ– Cmd+Vï¼ˆMacï¼‰
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                // å¦‚æœç„¦é»ä¸åœ¨è¼¸å…¥æ¡†ä¸Šï¼Œå‰‡è²¼ä¸Šå¾…è¾¦äº‹é …
                const activeElement = document.activeElement;
                const isInputField = activeElement.tagName === 'INPUT' || 
                                   activeElement.tagName === 'TEXTAREA' || 
                                   activeElement.tagName === 'SELECT' ||
                                   activeElement.isContentEditable;
                
                if (!isInputField) {
                    e.preventDefault();
                    pasteTodo();
                }
            }
        });

        // 3. å¢å¼· renderTodoRow - æ·»åŠ  data-todo-id ä»¥ä¾¿è­˜åˆ¥
        const originalRenderTodoRow = renderTodoRow;
        renderTodoRow = function(todo, inPack) {
            let html = originalRenderTodoRow(todo, inPack);
            // åœ¨ <tr æ¨™ç±¤ä¸­æ·»åŠ  data-todo-id
            html = html.replace('<tr class=', `<tr data-todo-id="${todo.id}" class=`);
            return html;
        };

        // 4. å³éµé¸å–®æ”¯æ´ï¼ˆå¯é¸ï¼‰
        document.addEventListener('contextmenu', function(e) {
            const row = e.target.closest('tr');
            if (row && row.dataset.todoId) {
                const todoId = parseInt(row.dataset.todoId);
                
                // å‰µå»ºè‡ªè¨‚å³éµé¸å–®
                e.preventDefault();
                
                // ç§»é™¤èˆŠé¸å–®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const oldMenu = document.getElementById('customContextMenu');
                if (oldMenu) oldMenu.remove();
                
                // å‰µå»ºé¸å–®
                const menu = document.createElement('div');
                menu.id = 'customContextMenu';
                menu.style.cssText = `
                    position: fixed;
                    left: ${e.pageX}px;
                    top: ${e.pageY}px;
                    background: white;
                    border: 1px solid #ccc;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    padding: 8px 0;
                    z-index: 10000;
                    min-width: 150px;
                `;
                
                const menuItems = [
                    { text: 'ğŸ“‹ è¤‡è£½æ­¤é …ç›®', action: () => copyTodo(todoId) },
                    { text: 'ğŸ“‹ è²¼ä¸Š', action: () => pasteTodo() },
                    { text: '---', action: null },
                    { text: 'ğŸ—‘ï¸ åˆªé™¤', action: () => deleteTodo(todoId) }
                ];
                
                menuItems.forEach(item => {
                    if (item.text === '---') {
                        const divider = document.createElement('div');
                        divider.style.cssText = 'height: 1px; background: #ddd; margin: 5px 0;';
                        menu.appendChild(divider);
                    } else {
                        const menuItem = document.createElement('div');
                        menuItem.textContent = item.text;
                        menuItem.style.cssText = `
                            padding: 10px 20px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.2s;
                        `;
                        menuItem.onmouseover = () => menuItem.style.background = '#f0f0f0';
                        menuItem.onmouseout = () => menuItem.style.background = 'white';
                        menuItem.onclick = () => {
                            item.action();
                            menu.remove();
                        };
                        menu.appendChild(menuItem);
                    }
                });
                
                document.body.appendChild(menu);
                
                // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
                setTimeout(() => {
                    const closeMenu = (e) => {
                        if (!menu.contains(e.target)) {
                            menu.remove();
                            document.removeEventListener('click', closeMenu);
                        }
                    };
                    document.addEventListener('click', closeMenu);
                }, 0);
            }
        });

        // 5. æ‰¹é‡è¤‡è£½åŠŸèƒ½ï¼ˆå¯é¸ï¼‰- è¤‡è£½æ•´å€‹è¡¨æ ¼åˆ° Excel
        function copyTableToClipboard() {
            const table = document.querySelector('#todoList table');
            if (!table) {
                alert('æ²’æœ‰è³‡æ–™å¯è¤‡è£½ï¼');
                return;
            }
            
            // å‰µå»ºä¸€å€‹è‡¨æ™‚å…ƒç´ ä¾†é¸å–æ•´å€‹è¡¨æ ¼
            const range = document.createRange();
            range.selectNode(table);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                // åŸ·è¡Œè¤‡è£½å‘½ä»¤
                document.execCommand('copy');
                selection.removeAllRanges();
                showToast('âœ… è¡¨æ ¼å·²è¤‡è£½ï¼å¯è²¼åˆ° Excel');
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—ï¼š' + err);
            }
        }

        // 6. å–®å…ƒæ ¼é¸å–æ™‚ä¸è§¸ç™¼ç·¨è¼¯ï¼ˆæŒ‰ä½ Ctrl æˆ– Shiftï¼‰
        let isSelectingText = false;
        
        document.addEventListener('mousedown', function(e) {
            if (e.ctrlKey || e.shiftKey) {
                isSelectingText = true;
            }
        });
        
        document.addEventListener('mouseup', function(e) {
            setTimeout(() => {
                isSelectingText = false;
            }, 100);
        });

        // ä¿®æ”¹å–®å…ƒæ ¼é»æ“Šäº‹ä»¶ï¼Œé¿å…é¸å–æ–‡å­—æ™‚è§¸ç™¼ç·¨è¼¯
        const editableClickHandler = function(id, field, cell, event, originalHandler) {
            if (isSelectingText) {
                event.stopPropagation();
                return;
            }
            
            // å¦‚æœæœ‰é¸å–æ–‡å­—ï¼Œä¸è§¸ç™¼ç·¨è¼¯
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                return;
            }
            
            originalHandler(id, field, cell, event);
        };

        // æç¤ºè¨Šæ¯
        console.log('âœ… è¤‡è£½è²¼ä¸ŠåŠŸèƒ½å·²å•Ÿç”¨ï¼');
        console.log('ğŸ“‹ åŠŸèƒ½èªªæ˜ï¼š');
        console.log('1. é¸å–æ–‡å­—å¾Œ Ctrl+Cï¼šè¤‡è£½æ–‡å­—åˆ°å¤–éƒ¨ï¼ˆExcelã€Word ç­‰ï¼‰');
        console.log('2. é»é¸ä¸€è¡Œå¾Œ Ctrl+Cï¼šè¤‡è£½æ•´å€‹å¾…è¾¦äº‹é …');
        console.log('3. Ctrl+Vï¼šè²¼ä¸Šå¾…è¾¦äº‹é …');
        console.log('4. å³éµé»æ“Šï¼šé¡¯ç¤ºå¿«æ·é¸å–®');
        console.log('5. é¸å–è¡¨æ ¼å…§å®¹å¯ç›´æ¥è¤‡è£½åˆ° Excel');
        
        // ========== è¤‡è£½è²¼ä¸ŠåŠŸèƒ½å¢å¼·çµæŸ ==========

        // ========== è‡ªå‹•æ›´æ–°æ—¥æœŸæª¢æŸ¥ ==========
        
        // è¨˜éŒ„ä¸Šæ¬¡æª¢æŸ¥çš„æ—¥æœŸ
        let lastCheckDate = new Date().toDateString();
        
        // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ—¥æœŸæ˜¯å¦è®Šæ›´
        setInterval(function() {
            const currentDate = new Date().toDateString();
            
            if (currentDate !== lastCheckDate) {
                // æ—¥æœŸæ”¹è®Šäº†ï¼
                console.log('ğŸ“… æ—¥æœŸå·²æ›´æ–°ï¼šå¾', lastCheckDate, 'åˆ°', currentDate);
                lastCheckDate = currentDate;
                
                // é‡æ–°æ¸²æŸ“æ‰€æœ‰é …ç›®ï¼ˆæ›´æ–°éæœŸç‹€æ…‹ï¼‰
                updateStatistics();
                renderTodos();
                
                // é¡¯ç¤ºæç¤º
                showDateChangeNotification();
            }
        }, 60000); // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
        
        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç•¶å‰æ—¥æœŸ
        function showCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            const timeStr = now.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            console.log('ğŸ“… ç•¶å‰æ—¥æœŸæ™‚é–“ï¼š', dateStr, timeStr);
        }
        
        // å„²å­˜æ¨™é¡Œ
        function saveTitle() {
            const title = document.getElementById('mainTitle');
            const titleText = title.textContent || title.innerText;
            localStorage.setItem('customTitle', titleText);
            console.log('âœ“ æ¨™é¡Œå·²å„²å­˜ï¼š', titleText);
        }
        
        // è¼‰å…¥æ¨™é¡Œ
        function loadTitle() {
            const savedTitle = localStorage.getItem('customTitle');
            if (savedTitle) {
                document.getElementById('mainTitle').innerHTML = savedTitle;
                console.log('âœ“ å·²è¼‰å…¥è‡ªè¨‚æ¨™é¡Œ');
            }
        }
        
        // é¡¯ç¤ºæ—¥æœŸè®Šæ›´é€šçŸ¥
        function showDateChangeNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px 50px;
                border-radius: 15px;
                font-size: 18px;
                font-weight: 600;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                animation: fadeIn 0.5s ease;
            `;
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            notification.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“…</div>
                <div style="font-size: 20px; margin-bottom: 10px;">æ—¥æœŸå·²æ›´æ–°</div>
                <div style="font-size: 16px; opacity: 0.9;">${dateStr}</div>
                <div style="font-size: 12px; margin-top: 15px; opacity: 0.8;">éæœŸç‹€æ…‹å·²è‡ªå‹•æ›´æ–°</div>
            `;
            
            document.body.appendChild(notification);
            
            // 3 ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // æ·»åŠ æ·¡å…¥æ·¡å‡ºå‹•ç•«
        const dateUpdateStyle = document.createElement('style');
        dateUpdateStyle.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            }
        `;
        document.head.appendChild(dateUpdateStyle);
        
        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç•¶å‰æ—¥æœŸ
        showCurrentDate();
        
        // æ¯å°æ™‚æ›´æ–°ä¸€æ¬¡æ—¥æœŸé¡¯ç¤º
        setInterval(showCurrentDate, 3600000);
        
        console.log('âœ… è‡ªå‹•æ—¥æœŸæ›´æ–°åŠŸèƒ½å·²å•Ÿç”¨');
        console.log('â° æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ—¥æœŸè®Šæ›´');
        console.log('ğŸ“… æ—¥æœŸæ”¹è®Šæ™‚æœƒè‡ªå‹•æ›´æ–°éæœŸç‹€æ…‹');
        
        // ========== è‡ªå‹•æ›´æ–°æ—¥æœŸæª¢æŸ¥çµæŸ ==========
        
        // ========== é–‹å§‹æ—¥æœŸå¿«é€Ÿè¼¸å…¥åŒæ­¥ ==========
        
        // åŒæ­¥é–‹å§‹æ—¥æœŸæ‰‹å‹•è¼¸å…¥å’Œæ—¥æœŸé¸æ“‡å™¨
        document.getElementById('startDateManual').addEventListener('input', function(e) {
            const input = e.target.value.trim();
            if (!input) {
                document.getElementById('startDateInput').value = '';
                return;
            }
            
            // è§£æè¼¸å…¥ï¼ˆæ”¯æ´ 1023, 10-23, 10/23 ç­‰æ ¼å¼ï¼‰
            let month, day;
            
            if (/^\d{4}$/.test(input)) {
                // æ ¼å¼ï¼š1023
                month = parseInt(input.substring(0, 2));
                day = parseInt(input.substring(2, 4));
            } else if (/^\d{1,2}[-\/]\d{1,2}$/.test(input)) {
                // æ ¼å¼ï¼š10-23 æˆ– 10/23
                const parts = input.split(/[-\/]/);
                month = parseInt(parts[0]);
                day = parseInt(parts[1]);
            } else {
                return; // æ ¼å¼ä¸æ­£ç¢ºï¼Œä¸è™•ç†
            }
            
            // é©—è­‰æ—¥æœŸ
            if (month < 1 || month > 12 || day < 1 || day > 31) {
                return;
            }
            
            // ä½¿ç”¨ç•¶å‰å¹´ä»½
            const year = new Date().getFullYear();
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            document.getElementById('startDateInput').value = dateStr;
        });
        
        // åŒæ­¥æ—¥æœŸé¸æ“‡å™¨åˆ°æ‰‹å‹•è¼¸å…¥
        document.getElementById('startDateInput').addEventListener('change', function(e) {
            const dateValue = e.target.value;
            if (dateValue) {
                const date = new Date(dateValue);
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                document.getElementById('startDateManual').value = `${month}${day}`;
            } else {
                document.getElementById('startDateManual').value = '';
            }
        });
        
        console.log('âœ… é–‹å§‹æ—¥æœŸå¿«é€Ÿè¼¸å…¥å·²å•Ÿç”¨');
        console.log('ğŸ“… ç¯„ä¾‹ï¼šè¼¸å…¥ 1023 = ä»Šå¹´10æœˆ23æ—¥');
        
        // ========== é–‹å§‹æ—¥æœŸå¿«é€Ÿè¼¸å…¥çµæŸ ==========
    </script>
</body>
</html>