<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待辦事項清單</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', 'KaiTi', '標楷體', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #000000;
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 20px;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
        }

        h1 {
            color: #000000;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-group label {
            font-size: 12px;
            color: #000000;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-btn {
            grid-column: 1 / -1;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .add-btn:active {
            transform: translateY(0);
        }

        .current-date {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .todo-list {
            list-style: none;
        }

        .todo-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
            color: #000000;
            table-layout: auto;
        }

        .todo-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .todo-table th {
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .todo-table th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .todo-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
            font-size: 12px;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            line-height: 1.4;
        }

        .todo-table tr {
            transition: background 0.2s;
        }

        .todo-table tbody tr:hover {
            background: #f8f9fa;
        }

        .todo-table tbody tr.completed {
            opacity: 0.6;
        }

        .todo-table tbody tr.completed td:nth-child(2) {
            text-decoration: line-through;
        }

        .todo-table tbody tr.overdue {
            background: #ffcccc !important;  /* 深一點的紅色背景 */
            border-left: 6px solid #cc0000 !important;  /* 深紅色粗邊框 */
            box-shadow: 0 0 0 2px #ff4444;  /* 更明顯的陰影 */
        }
        
        .todo-table tbody tr.overdue:hover {
            background: #ffb3b3 !important;  /* hover 時更深的紅 */
        }

        .todo-table tbody tr.priority-veryhigh {
            border-left: 6px solid #ff6b6b;
            background: #ffe0e0 !important;
        }

        .todo-table tbody tr.priority-high {
            border-left: 5px solid #4dabf7;
            background: #d0ebff !important;
        }

        .todo-table tbody tr.priority-medium {
            border-left: 4px solid #ffd93d;
        }

        .todo-table tbody tr.priority-low {
            border-left: 4px solid #51cf66;
        }

        .todo-table tbody tr.priority-verylow {
            border-left: 4px solid #74c0fc;
        }

        .editable-cell {
            cursor: pointer;
            position: relative;
            user-select: text; /* 允許選取文字 */
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .editable-cell:hover::after {
            content: '✏️';
            position: absolute;
            right: 5px;
            font-size: 12px;
        }
        
        /* 選取文字時的樣式 */
        .editable-cell::selection {
            background: #b3d4fc;
            color: #000;
        }
        
        .editable-cell::-moz-selection {
            background: #b3d4fc;
            color: #000;
        }

        .todo-table tbody tr.in-pack td:first-child {
            padding-left: 20px;
        }

        .pack-header-row {
            border-left: none !important;
        }

        .divider-row {
            border-left: none !important;
        }

        .edit-input {
            width: 100%;
            padding: 5px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 14px;
        }

        .edit-select {
            width: 100%;
            padding: 5px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 14px;
            position: relative;
            z-index: 1000;
        }

        .category-badge,
        .priority-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
        }

        .category-work {
            background: #d0e7ff;
            color: #000000;
        }

        .category-personal {
            background: #f3d9fa;
            color: #000000;
        }

        .category-urgent {
            background: #ffe0e0;
            color: #000000;
        }

        .category-other {
            background: #e9ecef;
            color: #000000;
        }

        .category-custom {
            background: #d0e7ff;
            color: #000000;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
        }

        .status-notstarted {
            background: #e9ecef;
            color: #000000;
        }

        .status-inprogress {
            background: #d0ebff;
            color: #000000;
        }

        .status-pending {
            background: #fff3bf;
            color: #000000;
        }

        .status-blocked {
            background: #ffe0e0;
            color: #000000;
        }

        .priority-veryhigh {
            background: #ffcccc;
            color: #000000;
            font-weight: bold;
            animation: pulse 10s infinite;
        }

        .priority-high {
            background: #ffd9d9;
            color: #000000;
            font-weight: bold;
        }

        .priority-medium {
            background: #fff3bf;
            color: #000000;
        }

        .priority-low {
            background: #d3f9d8;
            color: #000000;
        }

        .priority-verylow {
            background: #d0ebff;
            color: #000000;
        }

        .priority-urgent {
            background: #ffd9d9;
            color: #000000;
            font-weight: bold;
        }

        .priority-veryurgent {
            background: #ffcccc;
            color: #000000;
            font-weight: bold;
            animation: pulse 10s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        .overdue-text {
            color: #cc0000 !important;
            font-weight: 900;
            text-shadow: 0 0 2px rgba(204, 0, 0, 0.3);
        }

        .todo-actions {
            display: flex;
            gap: 8px;
        }

        .delete-btn {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .pack-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            margin: 25px 0 10px 0;
            border-radius: 10px;
            color: white;
        }

        .pack-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .pack-icon {
            font-size: 20px;
        }

        .pack-name {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .pack-count {
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
        }

        .pack-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .pack-progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .pack-divider {
            margin: 30px 0 15px 0;
            padding: 10px 15px;
            background: #f0f0f0;
            border-radius: 8px;
            color: #666;
            font-weight: 500;
            font-size: 14px;
        }

        .todo-item.in-pack {
            margin-left: 20px;
            border-left-width: 3px;
        }

        .completed-section {
            margin-top: 30px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }

        .completed-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #000000;
            transition: background 0.2s;
            margin-bottom: 10px;
        }

        .completed-header:hover {
            background: #e9ecef;
        }

        #completedToggleIcon {
            font-size: 12px;
            transition: transform 0.2s;
        }

        @media (max-width: 768px) {
            .todo-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .input-section {
                grid-template-columns: 1fr;
            }

            .todo-item.in-pack {
                margin-left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="mainTitle" contenteditable="true" style="cursor: text; outline: none;" onblur="saveTitle()" title="點擊編輯標題">📝 待辦事項清單 <span style="font-size: 12px; color: #999; font-weight: normal;">v2025.01</span></h1>
        
        <!-- 複製貼上功能說明 -->
        <div id="copyPasteInfo" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
                <strong style="font-size: 16px;">💡 複製貼上功能已啟用</strong>
                <div style="font-size: 13px; margin-top: 8px; line-height: 1.6; opacity: 0.95;">
                    <span style="display: inline-block; margin-right: 20px;">📋 <strong>選取文字</strong> + Ctrl+C：複製到 Excel/Word</span>
                    <span style="display: inline-block; margin-right: 20px;">📋 <strong>點選一行</strong> + Ctrl+C：複製項目</span>
                    <span style="display: inline-block; margin-right: 20px;">📋 <strong>Ctrl+V</strong>：貼上項目</span>
                    <span style="display: inline-block;">📋 <strong>右鍵</strong>：快捷選單</span>
                </div>
            </div>
            <button onclick="document.getElementById('copyPasteInfo').style.display='none'" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; margin-left: 15px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                知道了
            </button>
        </div>
        
        <div id="statistics" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: 600; color: #667eea;" id="statTotal">0</div>
                    <div style="font-size: 12px; color: #666;">總計</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 600; color: #ff5252;" id="statIncomplete">0</div>
                    <div style="font-size: 12px; color: #666;">待處理</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 600; color: #28a745;" id="statCompleted">0</div>
                    <div style="font-size: 12px; color: #666;">已完成</div>
                </div>
                <div>
                    <div style="font-size: 28px; font-weight: 900; color: #cc0000; text-shadow: 0 0 4px rgba(204, 0, 0, 0.5); animation: pulse 10s infinite;" id="statOverdue">0</div>
                    <div style="font-size: 12px; color: #666; font-weight: 600;">⚠️ 已逾期</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 600; color: #d50000;" id="statUrgent">0</div>
                    <div style="font-size: 12px; color: #666;">非常緊急</div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <button onclick="exportData()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                📤 匯出資料
            </button>
            <button onclick="document.getElementById('importFile').click()" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                📥 匯入資料
            </button>
            <button id="undoBtn" onclick="undoAction()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;" disabled>
                ↶ Undo
            </button>
            <button id="redoBtn" onclick="redoAction()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;" disabled>
                ↷ Redo
            </button>
            <button onclick="pasteTodo()" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                📋 貼上
            </button>
            <button onclick="copySelectedItems()" style="padding: 10px 20px; background: #20c997; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;" title="複製勾選的項目">
                ☑️ 複製選取
            </button>
            <button onclick="copyTableToClipboard()" style="padding: 10px 20px; background: #6f42c1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;" title="複製整個表格到 Excel">
                📊 複製表格
            </button>
            <button onclick="clearCompletedData()" style="padding: 10px 20px; background: #ffc107; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                🗑️ 清空已完成
            </button>
            <button onclick="clearIncompleteData()" style="padding: 10px 20px; background: #ff5252; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                🗑️ 清空待辦
            </button>
            <button onclick="clearAllData()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                🗑️ 清空全部
            </button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)" />
        </div>
        
        <div class="current-date" id="currentDate"></div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <span style="font-weight: 600; color: #000;">排序方式：</span>
                <button onclick="setSortMode('pack')" id="sortPack" class="sort-btn active" style="padding: 8px 16px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    📦 按組別
                </button>
                <button onclick="setSortMode('due')" id="sortDue" class="sort-btn" style="padding: 8px 16px; border: 2px solid #ccc; background: white; color: #000; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    📅 到期日
                </button>
                <button onclick="setSortMode('balance')" id="sortBalance" class="sort-btn" style="padding: 8px 16px; border: 2px solid #ccc; background: white; color: #000; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    ⏱️ 剩餘天數
                </button>
                <button onclick="setSortMode('priority')" id="sortPriority" class="sort-btn" style="padding: 8px 16px; border: 2px solid #ccc; background: white; color: #000; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    ⭐ 優先級
                </button>
                <button onclick="setSortMode('category')" id="sortCategory" class="sort-btn" style="padding: 8px 16px; border: 2px solid #ccc; background: white; color: #000; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    📁 分類
                </button>
                <button onclick="toggleSortOrder()" id="sortOrder" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    ▲ 升序
                </button>
            </div>
        </div>
        
        <!-- 篩選區域 -->
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                <span style="font-weight: 600; color: #000;">🔍 篩選：</span>
                <button onclick="clearAllFilters()" style="padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    ✖️ 清除所有篩選
                </button>
                <span id="filterCount" style="font-size: 13px; color: #666;"></span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                <!-- 完成狀態篩選 -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">完成狀態</label>
                    <select id="filterCompleted" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">全部</option>
                        <option value="false">❌ 未完成</option>
                        <option value="true">✅ 已完成</option>
                    </select>
                </div>
                
                <!-- 優先級篩選 -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">優先級</label>
                    <select id="filterPriority" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">全部</option>
                        <option value="veryhigh">非常緊急!!</option>
                        <option value="high">緊急</option>
                        <option value="medium">普通</option>
                        <option value="low">不急</option>
                        <option value="verylow">非常不急</option>
                    </select>
                </div>
                
                <!-- 狀態篩選 -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">Status</label>
                    <select id="filterStatus" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">全部</option>
                        <option value="notstarted">尚未開始</option>
                        <option value="inprogress">進行中</option>
                        <option value="pending">等待中</option>
                        <option value="blocked">受阻</option>
                        <option value="completed">已完成</option>
                    </select>
                </div>
                
                <!-- 困難度篩選 -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">困難度</label>
                    <select id="filterDifficulty" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">全部</option>
                        <option value="veryeasy">😊 非常簡單</option>
                        <option value="easy">🙂 簡單</option>
                        <option value="medium">😐 普通</option>
                        <option value="hard">😰 困難</option>
                        <option value="veryhard">😱 非常困難</option>
                    </select>
                </div>
                
                <!-- 分類篩選 -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">Category</label>
                    <input type="text" id="filterCategory" onkeyup="applyFilters()" placeholder="輸入分類名稱..." style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;" />
                </div>
                
                <!-- Pack 篩選 -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">Pack</label>
                    <input type="text" id="filterPack" onkeyup="applyFilters()" placeholder="輸入 Pack 名稱..." style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;" />
                </div>
                
                <!-- 過期狀態篩選 -->
                <div>
                    <label style="font-size: 12px; color: #000; font-weight: 500; display: block; margin-bottom: 4px;">過期狀態</label>
                    <select id="filterOverdue" onchange="applyFilters()" style="width: 100%; padding: 6px; border: 2px solid #90caf9; border-radius: 4px; font-size: 12px;">
                        <option value="">全部</option>
                        <option value="true">⚠️ 已過期</option>
                        <option value="false">⏰ 未過期</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <label>待辦事項名稱 *</label>
                <input type="text" id="todoInput" placeholder="輸入待辦事項..." />
            </div>
            
            <div class="input-group">
                <label>Category</label>
                <input type="text" id="categoryInput" placeholder="輸入分類..." />
            </div>
            
            <div class="input-group">
                <label>Priority</label>
                <select id="priorityInput" onchange="updatePriorityColor(this)">
                    <option value="veryhigh" style="background: #cc0000; color: white; font-weight: bold;">非常緊急!!</option>
                    <option value="high" style="background: #ff6666; color: white;">緊急</option>
                    <option value="medium" selected>普通</option>
                    <option value="low">不急</option>
                    <option value="verylow">非常不急</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Due Date *</label>
                <input type="text" id="dueDateManual" placeholder="快速輸入：0115 或 1-15 或 20250115" style="width: 100%; margin-bottom: 5px;" />
                <input type="date" id="dueInput" style="width: 100%;" />
                <div style="font-size: 11px; color: #666; margin-top: 3px;">📝 手動輸入（沒年份預設今年）或 📅 用日曆選擇</div>
            </div>
            
            <div class="input-group">
                <label>Combine Pack</label>
                <input type="text" id="combinepackInput" placeholder="組合包名稱" />
            </div>
            
            <div class="input-group">
                <label>Status</label>
                <select id="statusInput" onchange="toggleCustomStatusInput()">
                    <option value="">未設定</option>
                    <option value="notstarted">尚未開始</option>
                    <option value="inprogress">進行中</option>
                    <option value="pending">等待中</option>
                    <option value="blocked">受阻</option>
                    <option value="completed">已完成</option>
                    <option value="custom">其他...</option>
                </select>
            </div>
            
            <div class="input-group" id="customStatusGroup" style="display: none;">
                <label>自訂狀態</label>
                <input type="text" id="customStatusInput" placeholder="輸入自訂狀態名稱" />
            </div>
            
            <div class="input-group">
                <label>Remark</label>
                <input type="text" id="remarkInput" placeholder="備註說明" />
            </div>
            
            <div class="input-group">
                <label>開始日期（選填）</label>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <input type="text" id="startDateManual" placeholder="快速輸入：1023 或 10-23" style="width: 120px; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 13px;" />
                    <input type="date" id="startDateInput" style="flex: 1;" />
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 3px;">📅 快速輸入範例：1023 = 今年10月23日，不填年份預設今年</div>
            </div>
            
            <div class="input-group">
                <label>困難度</label>
                <select id="difficultyInput">
                    <option value="">未設定</option>
                    <option value="veryeasy">😊 非常簡單</option>
                    <option value="easy">🙂 簡單</option>
                    <option value="medium" selected>😐 普通</option>
                    <option value="hard">😰 困難</option>
                    <option value="veryhard">😱 非常困難</option>
                </select>
            </div>
            
            <button class="add-btn" onclick="addTodo()">➕ 新增待辦事項</button>
        </div>

        <div id="todoList">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/>
                </svg>
                <p>還沒有待辦事項，開始新增一個吧！</p>
            </div>
        </div>
    </div>

    <script>
        let todos = JSON.parse(localStorage.getItem('todos')) || [];
        let undoHistory = [];
        let redoHistory = [];
        const MAX_UNDO_HISTORY = 10;
        let currentSortMode = 'pack'; // pack, due, balance, priority, category
        let currentFilters = {
            completed: '',
            priority: '',
            status: '',
            difficulty: '',
            category: '',
            pack: '',
            overdue: ''
        };
        let sortAscending = true;

        // 儲存到 undo 歷史
        function saveToHistory() {
            undoHistory.push(JSON.parse(JSON.stringify(todos)));
            if (undoHistory.length > MAX_UNDO_HISTORY) {
                undoHistory.shift();
            }
            // 清空 redo 歷史（因為做了新操作）
            redoHistory = [];
            updateUndoRedoButtons();
        }

        // 更新 Undo/Redo 按鈕狀態
        function updateUndoRedoButtons() {
            updateUndoButton();
            updateRedoButton();
        }

        // 更新 Undo 按鈕狀態
        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            if (undoHistory.length > 0) {
                undoBtn.disabled = false;
                undoBtn.style.background = '#6c757d';
                undoBtn.style.cursor = 'pointer';
            } else {
                undoBtn.disabled = true;
                undoBtn.style.background = '#c0c0c0';
                undoBtn.style.cursor = 'not-allowed';
            }
        }

        // 更新 Redo 按鈕狀態
        function updateRedoButton() {
            const redoBtn = document.getElementById('redoBtn');
            if (redoHistory.length > 0) {
                redoBtn.disabled = false;
                redoBtn.style.background = '#6c757d';
                redoBtn.style.cursor = 'pointer';
            } else {
                redoBtn.disabled = true;
                redoBtn.style.background = '#c0c0c0';
                redoBtn.style.cursor = 'not-allowed';
            }
        }

        // Undo 操作
        function undoAction() {
            if (undoHistory.length === 0) {
                alert('沒有可以復原的操作！');
                return;
            }
            
            // 儲存當前狀態到 redo 歷史
            redoHistory.push(JSON.parse(JSON.stringify(todos)));
            if (redoHistory.length > MAX_UNDO_HISTORY) {
                redoHistory.shift();
            }
            
            todos = undoHistory.pop();
            saveTodos();
            updateStatistics();
            updateUndoRedoButtons();
            renderTodos();
        }

        // Redo 操作
        function redoAction() {
            if (redoHistory.length === 0) {
                alert('沒有可以重做的操作！');
                return;
            }
            
            // 儲存當前狀態到 undo 歷史
            undoHistory.push(JSON.parse(JSON.stringify(todos)));
            if (undoHistory.length > MAX_UNDO_HISTORY) {
                undoHistory.shift();
            }
            
            todos = redoHistory.pop();
            saveTodos();
            updateStatistics();
            updateUndoRedoButtons();
            renderTodos();
        }

        // 解析手動輸入的日期
        function parseManualDate(input) {
            if (!input) return null;
            
            // 移除所有非數字和連字號、斜線
            let cleaned = input.replace(/[^0-9-\/]/g, '');
            
            // 獲取當前年份
            const currentYear = new Date().getFullYear();
            
            // 格式：MMDD (4位數字，沒有年份) - 預設今年
            if (/^\d{4}$/.test(cleaned)) {
                const month = cleaned.substring(0, 2);
                const day = cleaned.substring(2, 4);
                return `${currentYear}-${month}-${day}`;
            }
            
            // 格式：M-DD 或 MM-DD (沒有年份) - 預設今年
            if (/^\d{1,2}-\d{1,2}$/.test(cleaned)) {
                const parts = cleaned.split('-');
                const month = parts[0].padStart(2, '0');
                const day = parts[1].padStart(2, '0');
                return `${currentYear}-${month}-${day}`;
            }
            
            // 格式：M/DD 或 MM/DD (沒有年份) - 預設今年
            if (/^\d{1,2}\/\d{1,2}$/.test(cleaned)) {
                const parts = cleaned.split('/');
                const month = parts[0].padStart(2, '0');
                const day = parts[1].padStart(2, '0');
                return `${currentYear}-${month}-${day}`;
            }
            
            // 格式：YYYYMMDD (8位數字)
            if (/^\d{8}$/.test(cleaned)) {
                const year = cleaned.substring(0, 4);
                const month = cleaned.substring(4, 6);
                const day = cleaned.substring(6, 8);
                return `${year}-${month}-${day}`;
            }
            
            // 格式：YYYY-MM-DD 或 YYYY-M-D
            if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(cleaned)) {
                const parts = cleaned.split('-');
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // 格式：YYYY/MM/DD
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(input)) {
                const parts = input.split('/');
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return null;
        }

        // 更新當前日期顯示
        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            const timeStr = now.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentDate').innerHTML = `
                <div style="font-size: 24px; font-weight: 700; color: #667eea; text-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);">
                    📅 ${dateStr}
                </div>
                <div style="font-size: 18px; font-weight: 600; color: #28a745; margin-top: 5px;">
                    🕒 ${timeStr}
                </div>
            `;
        }
        
        // 更新 Priority 選單顏色
        function updatePriorityColor(selectEl) {
            const value = selectEl.value;
            if (value === 'veryhigh') {
                selectEl.style.background = '#cc0000';
                selectEl.style.color = 'white';
                selectEl.style.fontWeight = 'bold';
            } else if (value === 'high') {
                selectEl.style.background = '#ff6666';
                selectEl.style.color = 'white';
                selectEl.style.fontWeight = 'normal';
            } else {
                selectEl.style.background = '';
                selectEl.style.color = '';
                selectEl.style.fontWeight = '';
            }
        }

        // 更新統計資訊
        function updateStatistics() {
            const statDiv = document.getElementById('statistics');
            
            if (todos.length === 0) {
                statDiv.style.display = 'none';
                return;
            }
            
            statDiv.style.display = 'block';
            
            const total = todos.length;
            const incomplete = todos.filter(t => !t.completed).length;
            const completed = todos.filter(t => t.completed).length;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const overdue = todos.filter(t => !t.completed && new Date(t.due) < today).length;
            const urgent = todos.filter(t => !t.completed && t.priority === 'veryhigh').length;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statIncomplete').textContent = incomplete;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statOverdue').textContent = overdue;
            document.getElementById('statUrgent').textContent = urgent;
            
            // 顯示過期警告
            updateOverdueAlert(overdue);
        }
        
        // 更新過期警告橫幅
        function updateOverdueAlert(overdueCount) {
            let alertDiv = document.getElementById('overdueAlert');
            
            if (overdueCount > 0) {
                // 有過期項目，顯示警告
                if (!alertDiv) {
                    alertDiv = document.createElement('div');
                    alertDiv.id = 'overdueAlert';
                    alertDiv.style.cssText = `
                        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
                        color: white;
                        padding: 15px 20px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        box-shadow: 0 4px 16px rgba(204, 0, 0, 0.5);
                        animation: shake 0.5s ease;
                        border: 3px solid #ff0000;
                    `;
                    
                    // 插入到統計區域後面
                    const statsDiv = document.getElementById('statistics');
                    statsDiv.parentNode.insertBefore(alertDiv, statsDiv.nextSibling);
                }
                
                alertDiv.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">
                            ⚠️ 注意！您有 ${overdueCount} 個項目已過期
                        </div>
                        <div style="font-size: 12px; opacity: 0.95;">
                            請儘快處理過期項目，或更新到期日期
                        </div>
                    </div>
                    <button onclick="scrollToFirstOverdue()" style="
                        background: rgba(255,255,255,0.2);
                        border: 2px solid rgba(255,255,255,0.5);
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        margin-left: 15px;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        查看過期項目 →
                    </button>
                `;
                alertDiv.style.display = 'flex';
            } else {
                // 沒有過期項目，隱藏警告
                if (alertDiv) {
                    alertDiv.style.display = 'none';
                }
            }
        }
        
        // 滾動到第一個過期項目
        function scrollToFirstOverdue() {
            const overdueRow = document.querySelector('tr.overdue');
            if (overdueRow) {
                overdueRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // 高亮效果
                overdueRow.style.transition = 'all 0.3s';
                overdueRow.style.transform = 'scale(1.02)';
                overdueRow.style.boxShadow = '0 0 20px rgba(255, 68, 68, 0.5)';
                setTimeout(() => {
                    overdueRow.style.transform = '';
                    overdueRow.style.boxShadow = '';
                }, 1000);
            }
        }
        
        // 添加震動動畫
        const shakeStyle = document.createElement('style');
        shakeStyle.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(shakeStyle);

        // 清空已完成項目
        function clearCompletedData() {
            const completedCount = todos.filter(t => t.completed).length;
            
            if (completedCount === 0) {
                alert('目前沒有已完成的項目！');
                return;
            }
            
            const confirmation = confirm(`⚠️ 確定要清空所有已完成項目嗎？\n\n這將刪除 ${completedCount} 筆已完成的待辦事項。`);
            
            if (confirmation) {
                saveToHistory();
                todos = todos.filter(t => !t.completed);
                saveTodos();
                updateStatistics();
                renderTodos();
                alert('✅ 已清空所有已完成項目！');
            }
        }

        // 清空待辦項目
        function clearIncompleteData() {
            const incompleteCount = todos.filter(t => !t.completed).length;
            
            if (incompleteCount === 0) {
                alert('目前沒有待辦項目！');
                return;
            }
            
            const confirmation = confirm(`⚠️ 確定要清空所有待辦項目嗎？\n\n這將刪除 ${incompleteCount} 筆未完成的待辦事項。\n\n建議先匯出資料備份。`);
            
            if (confirmation) {
                saveToHistory();
                todos = todos.filter(t => t.completed);
                saveTodos();
                updateStatistics();
                renderTodos();
                alert('✅ 已清空所有待辦項目！');
            }
        }

        // 清空所有資料
        function clearAllData() {
            if (todos.length === 0) {
                alert('目前沒有任何資料！');
                return;
            }
            
            const confirmation = confirm(`⚠️ 確定要清空所有資料嗎？\n\n這將刪除所有 ${todos.length} 筆待辦事項，此操作無法復原！\n\n建議先匯出資料備份。`);
            
            if (confirmation) {
                const doubleCheck = confirm('真的確定要清空嗎？這是最後確認！');
                if (doubleCheck) {
                    saveToHistory();
                    todos = [];
                    saveTodos();
                    updateStatistics();
                    renderTodos();
                    alert('✅ 已清空所有資料！');
                }
            }
        }

        // 按Enter也可以新增
        document.getElementById('todoInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        // 切換自訂狀態輸入框
        function toggleCustomStatusInput() {
            const statusInput = document.getElementById('statusInput');
            const customStatusGroup = document.getElementById('customStatusGroup');
            
            if (statusInput.value === 'custom') {
                customStatusGroup.style.display = 'block';
                document.getElementById('customStatusInput').focus();
            } else {
                customStatusGroup.style.display = 'none';
            }
        }

        function addTodo() {
            const todoInput = document.getElementById('todoInput');
            const categoryInput = document.getElementById('categoryInput');
            const priorityInput = document.getElementById('priorityInput');
            const dueDateManual = document.getElementById('dueDateManual');
            const dueInput = document.getElementById('dueInput');
            const combinepackInput = document.getElementById('combinepackInput');
            const statusInput = document.getElementById('statusInput');
            const customStatusInput = document.getElementById('customStatusInput');
            const remarkInput = document.getElementById('remarkInput');

            const name = todoInput.value.trim();
            const category = categoryInput.value;
            const priority = priorityInput.value;
            const combinepack = combinepackInput.value.trim();
            let status = statusInput.value;
            const remark = remarkInput.value.trim();
            const startDate = document.getElementById('startDateInput').value || '';
            const difficulty = document.getElementById('difficultyInput').value || '';
            
            // 處理自訂狀態
            if (status === 'custom') {
                const customValue = customStatusInput.value.trim();
                if (customValue) {
                    status = 'custom:' + customValue;
                } else {
                    alert('請輸入自訂狀態名稱！');
                    return;
                }
            }
            
            // 優先使用手動輸入，如果手動輸入為空則使用日期選擇器
            let due = '';
            const manualDate = dueDateManual.value.trim();
            if (manualDate) {
                due = parseManualDate(manualDate);
                if (!due) {
                    alert('❌ 日期格式錯誤！\n\n請使用以下格式：\n- MMDD (例如：0115 = 今年1月15日)\n- M-DD (例如：1-15 = 今年1月15日)\n- YYYYMMDD (例如：20250115)\n- YYYY-MM-DD (例如：2025-01-15)\n- YYYY/MM/DD (例如：2025/01/15)\n\n💡 沒有輸入年份會自動使用今年！');
                    return;
                }
            } else {
                due = dueInput.value;
            }

            if (name === '') {
                alert('請輸入待辦事項名稱！');
                return;
            }

            if (due === '') {
                alert('請選擇或輸入截止日期！');
                return;
            }

            // 驗證日期是否有效
            const dateObj = new Date(due);
            if (isNaN(dateObj.getTime())) {
                alert('❌ 日期無效！請檢查日期格式。');
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            // 儲存到歷史記錄
            saveToHistory();

            const todo = {
                id: Date.now(),
                name: name,
                completed: false,
                category: category,
                priority: priority,
                due: due,
                combinepack: combinepack || '',
                status: status || '',
                remark: remark || '',
                startDate: startDate || '',
                difficulty: difficulty || '',
                dateToday: today
            };

            todos.push(todo);
            saveTodos();
            updateStatistics();
            renderTodos();

            // 清空輸入欄
            todoInput.value = '';
            categoryInput.value = '';
            combinepackInput.value = '';
            statusInput.value = '';
            customStatusInput.value = '';
            document.getElementById('customStatusGroup').style.display = 'none';
            remarkInput.value = '';
            dueDateManual.value = '';
            dueInput.value = '';
            document.getElementById('startDateInput').value = '';
            document.getElementById('difficultyInput').value = '';
            todoInput.focus();
        }

        function toggleComplete(id) {
            saveToHistory();
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                saveTodos();
                updateStatistics();
                renderTodos();
            }
        }

        function deleteTodo(id) {
            if (confirm('確定要刪除這個待辦事項嗎？')) {
                saveToHistory();
                todos = todos.filter(t => t.id !== id);
                saveTodos();
                updateStatistics();
                renderTodos();
            }
        }

        // 全選/取消全選
        function toggleSelectAll(checkbox) {
            const selectBoxes = document.querySelectorAll('.select-item');
            selectBoxes.forEach(box => {
                box.checked = checkbox.checked;
            });
            updateSelectCount();
        }

        // 更新選取計數
        function updateSelectCount() {
            const selectBoxes = document.querySelectorAll('.select-item:checked');
            const count = selectBoxes.length;
            
            // 可以在這裡顯示選取數量
            console.log(`已選取 ${count} 個項目`);
        }

        // 複製選取的項目
        function copySelectedItems() {
            const selectBoxes = document.querySelectorAll('.select-item:checked');
            
            if (selectBoxes.length === 0) {
                alert('❌ 請先勾選要複製的項目！');
                return;
            }

            const selectedIds = Array.from(selectBoxes).map(box => parseInt(box.dataset.todoId));
            const selectedTodos = todos.filter(t => selectedIds.includes(t.id));

            if (selectedTodos.length === 0) {
                alert('❌ 找不到選取的項目！');
                return;
            }

            // 複製到剪貼簿
            const todosData = JSON.stringify(selectedTodos);
            localStorage.setItem('copiedTodos', todosData);
            
            // 也存單個項目格式以兼容原有功能
            if (selectedTodos.length === 1) {
                localStorage.setItem('copiedTodo', JSON.stringify(selectedTodos[0]));
            }
            
            // 顯示提示
            showToast(`✅ 已複製 ${selectedTodos.length} 個項目！可以按「貼上」按鈕貼上`);
            
            // 取消勾選
            selectBoxes.forEach(box => box.checked = false);
            const selectAllBox = document.getElementById('selectAll');
            if (selectAllBox) selectAllBox.checked = false;
        }

        // 複製待辦事項
        function copyTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;
            
            // 複製到剪貼簿
            const todoData = JSON.stringify(todo);
            localStorage.setItem('copiedTodo', todoData);
            
            // 顯示提示
            showToast('✅ 已複製！可以在任何位置貼上');
        }

        // 貼上待辦事項
        function pasteTodo() {
            // 優先檢查批量複製
            const copiedTodosData = localStorage.getItem('copiedTodos');
            if (copiedTodosData) {
                try {
                    const copiedTodos = JSON.parse(copiedTodosData);
                    if (Array.isArray(copiedTodos) && copiedTodos.length > 0) {
                        saveToHistory();
                        
                        const today = new Date().toISOString().split('T')[0];
                        let baseTime = Date.now();
                        
                        copiedTodos.forEach((copiedTodo, index) => {
                            const newTodo = {
                                ...copiedTodo,
                                id: baseTime + index,
                                completed: false,
                                dateToday: today
                            };
                            todos.push(newTodo);
                        });
                        
                        saveTodos();
                        updateStatistics();
                        renderTodos();
                        
                        showToast(`✅ 已貼上 ${copiedTodos.length} 個項目！`);
                        return;
                    }
                } catch (error) {
                    console.error('批量貼上失敗：', error);
                }
            }
            
            // 單個項目貼上
            const copiedData = localStorage.getItem('copiedTodo');
            if (!copiedData) {
                alert('❌ 沒有可貼上的項目！請先複製項目。');
                return;
            }
            
            try {
                const copiedTodo = JSON.parse(copiedData);
                saveToHistory();
                
                // 建立新的項目（新的 ID 和日期）
                const newTodo = {
                    ...copiedTodo,
                    id: Date.now(),
                    completed: false,
                    dateToday: new Date().toISOString().split('T')[0]
                };
                
                todos.push(newTodo);
                saveTodos();
                updateStatistics();
                renderTodos();
                
                showToast('✅ 已貼上！');
            } catch (error) {
                alert('❌ 貼上失敗！資料格式錯誤。');
            }
        }

        // 複製列表（整批複製）
        function copySelectedTodos(ids) {
            const selectedTodos = todos.filter(t => ids.includes(t.id));
            if (selectedTodos.length === 0) return;
            
            localStorage.setItem('copiedTodos', JSON.stringify(selectedTodos));
            showToast(`✅ 已複製 ${selectedTodos.length} 個項目！`);
        }

        // 顯示提示訊息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // 添加動畫樣式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        function saveTodos() {
            localStorage.setItem('todos', JSON.stringify(todos));
        }

        // 設定排序模式
        function setSortMode(mode) {
            currentSortMode = mode;
            
            // 更新按鈕樣式
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.style.border = '2px solid #ccc';
                btn.style.background = 'white';
                btn.style.color = '#000';
            });
            
            // 根據 mode 找到對應的按鈕 ID
            const idMap = {
                'pack': 'sortPack',
                'due': 'sortDue',
                'balance': 'sortBalance',
                'priority': 'sortPriority',
                'category': 'sortCategory'
            };
            
            const activeBtn = document.getElementById(idMap[mode]);
            if (activeBtn) {
                activeBtn.style.border = '2px solid #667eea';
                activeBtn.style.background = '#667eea';
                activeBtn.style.color = 'white';
            }
            
            renderTodos();
        }

        // 切換升序/降序
        function toggleSortOrder() {
            sortAscending = !sortAscending;
            const btn = document.getElementById('sortOrder');
            if (sortAscending) {
                btn.innerHTML = '▲ 升序';
            } else {
                btn.innerHTML = '▼ 降序';
            }
            renderTodos();
        }

        // 通用排序函數
        function sortTodosByMode(todos) {
            return todos.sort((a, b) => {
                let comparison = 0;
                
                switch(currentSortMode) {
                    case 'due':
                        comparison = new Date(a.due) - new Date(b.due);
                        break;
                    case 'balance':
                        const todayDate = new Date();
                        todayDate.setHours(0, 0, 0, 0);
                        const aDate = new Date(a.due);
                        const bDate = new Date(b.due);
                        aDate.setHours(0, 0, 0, 0);
                        bDate.setHours(0, 0, 0, 0);
                        const aDiff = Math.ceil((aDate - todayDate) / (1000 * 60 * 60 * 24));
                        const bDiff = Math.ceil((bDate - todayDate) / (1000 * 60 * 60 * 24));
                        comparison = aDiff - bDiff;
                        break;
                    case 'priority':
                        const priorityOrder = { veryhigh: 0, high: 1, medium: 2, low: 3, verylow: 4 };
                        comparison = priorityOrder[a.priority] - priorityOrder[b.priority];
                        break;
                    case 'category':
                        const aCategory = a.category || '';
                        const bCategory = b.category || '';
                        comparison = aCategory.localeCompare(bCategory);
                        break;
                    case 'pack':
                    default:
                        // pack 模式在 renderTodos 中特別處理
                        return 0;
                }
                
                return sortAscending ? comparison : -comparison;
            });
        }

        // 應用篩選
        function applyFilters() {
            currentFilters.completed = document.getElementById('filterCompleted').value;
            currentFilters.priority = document.getElementById('filterPriority').value;
            currentFilters.status = document.getElementById('filterStatus').value;
            currentFilters.difficulty = document.getElementById('filterDifficulty').value;
            currentFilters.category = document.getElementById('filterCategory').value.toLowerCase().trim();
            currentFilters.pack = document.getElementById('filterPack').value.toLowerCase().trim();
            currentFilters.overdue = document.getElementById('filterOverdue').value;
            
            updateFilterCount();
            renderTodos();
        }
        
        // 清除所有篩選
        function clearAllFilters() {
            document.getElementById('filterCompleted').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDifficulty').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterPack').value = '';
            document.getElementById('filterOverdue').value = '';
            
            currentFilters = {
                completed: '',
                priority: '',
                status: '',
                difficulty: '',
                category: '',
                pack: '',
                overdue: ''
            };
            
            updateFilterCount();
            renderTodos();
        }
        
        // 更新篩選計數
        function updateFilterCount() {
            const activeFilters = Object.values(currentFilters).filter(v => v !== '').length;
            const countEl = document.getElementById('filterCount');
            if (activeFilters > 0) {
                countEl.textContent = `已套用 ${activeFilters} 個篩選條件`;
                countEl.style.color = '#1976d2';
                countEl.style.fontWeight = '600';
            } else {
                countEl.textContent = '未套用篩選';
                countEl.style.color = '#999';
                countEl.style.fontWeight = 'normal';
            }
        }
        
        // 檢查項目是否符合篩選條件
        function matchesFilters(todo, today) {
            // 完成狀態篩選
            if (currentFilters.completed !== '') {
                const isCompleted = currentFilters.completed === 'true';
                if (todo.completed !== isCompleted) return false;
            }
            
            // 優先級篩選
            if (currentFilters.priority !== '' && todo.priority !== currentFilters.priority) {
                return false;
            }
            
            // 狀態篩選
            if (currentFilters.status !== '') {
                if (todo.status !== currentFilters.status && 
                    !todo.status?.startsWith('custom:' + currentFilters.status)) {
                    return false;
                }
            }
            
            // 困難度篩選
            if (currentFilters.difficulty !== '' && todo.difficulty !== currentFilters.difficulty) {
                return false;
            }
            
            // 分類篩選
            if (currentFilters.category !== '') {
                if (!todo.category || !todo.category.toLowerCase().includes(currentFilters.category)) {
                    return false;
                }
            }
            
            // Pack 篩選
            if (currentFilters.pack !== '') {
                if (!todo.combinepack || !todo.combinepack.toLowerCase().includes(currentFilters.pack)) {
                    return false;
                }
            }
            
            // 過期狀態篩選
            if (currentFilters.overdue !== '') {
                const dueDate = new Date(todo.due);
                dueDate.setHours(0, 0, 0, 0);
                const isOverdue = !todo.completed && dueDate < today;
                const shouldShowOverdue = currentFilters.overdue === 'true';
                if (isOverdue !== shouldShowOverdue) return false;
            }
            
            return true;
        }

        function renderTodos() {
            const todoList = document.getElementById('todoList');
            
            if (todos.length === 0) {
                todoList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/>
                        </svg>
                        <p>還沒有待辦事項，開始新增一個吧！</p>
                    </div>
                `;
                return;
            }

            // 分離未完成和已完成的項目，並應用篩選
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const filteredTodos = todos.filter(t => matchesFilters(t, today));
            const incompleteTodos = filteredTodos.filter(t => !t.completed);
            const completedTodos = filteredTodos.filter(t => t.completed);
            
            // 如果篩選後沒有項目
            if (filteredTodos.length === 0) {
                todoList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/>
                        </svg>
                        <p>沒有符合篩選條件的項目</p>
                        <button onclick="clearAllFilters()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            清除篩選
                        </button>
                    </div>
                `;
                return;
            }

            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);

            let html = '<table class="todo-table"><thead><tr>';
            html += '<th style="width: 35px; min-width: 35px; font-size: 12px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" style="width: 16px; height: 16px; cursor: pointer;" title="全選/取消全選" /></th>';
            html += '<th style="width: 40px; min-width: 40px; font-size: 12px;">✓</th>';
            html += '<th style="min-width: 120px; max-width: 180px; font-size: 12px;">待辦事項</th>';
            html += '<th style="width: 80px; min-width: 80px; font-size: 11px;">Category</th>';
            html += '<th style="width: 85px; min-width: 85px; font-size: 11px;">Priority</th>';
            html += '<th style="width: 80px; min-width: 80px; font-size: 11px;">Status</th>';
            html += '<th style="width: 90px; min-width: 90px; font-size: 11px;">Due Date</th>';
            html += '<th style="width: 70px; min-width: 70px; font-size: 11px;">Balance</th>';
            html += '<th style="width: 90px; min-width: 90px; font-size: 11px;">開始日期</th>';
            html += '<th style="width: 70px; min-width: 70px; font-size: 11px;">週期</th>';
            html += '<th style="width: 75px; min-width: 75px; font-size: 11px;">難度</th>';
            html += '<th style="width: 90px; min-width: 90px; font-size: 11px;">Pack</th>';
            html += '<th style="width: 120px; min-width: 120px; font-size: 11px;">Remark</th>';
            html += '<th style="width: 100px; min-width: 100px; font-size: 11px;">操作</th>';
            html += '</tr></thead><tbody>';

            // 根據排序模式渲染
            if (currentSortMode === 'pack') {
                // Pack 模式：按組別分組（包含已完成項目來計算百分比）
                const groupedByPack = {};
                const noPack = [];
                
                // 先用所有項目（包括已完成）來分組計算百分比
                const allGroupedByPack = {};
                todos.forEach(todo => {
                    if (todo.combinepack && todo.combinepack.trim() !== '') {
                        if (!allGroupedByPack[todo.combinepack]) {
                            allGroupedByPack[todo.combinepack] = [];
                        }
                        allGroupedByPack[todo.combinepack].push(todo);
                    }
                });
                
                // 只用未完成項目來顯示
                incompleteTodos.forEach(todo => {
                    if (todo.combinepack && todo.combinepack.trim() !== '') {
                        if (!groupedByPack[todo.combinepack]) {
                            groupedByPack[todo.combinepack] = [];
                        }
                        groupedByPack[todo.combinepack].push(todo);
                    } else {
                        noPack.push(todo);
                    }
                });

                // 對每個組內的項目排序（優先按日期）
                const sortTodosInGroup = (todos) => {
                    return todos.sort((a, b) => {
                        const dateDiff = new Date(a.due) - new Date(b.due);
                        if (dateDiff !== 0) return dateDiff;
                        const priorityOrder = { veryhigh: 0, high: 1, medium: 2, low: 3, verylow: 4 };
                        return priorityOrder[a.priority] - priorityOrder[b.priority];
                    });
                };

                const sortedNoPack = sortTodosInGroup(noPack);

                // 計算每個 Pack 的最早到期日，並排序 Pack
                const packWithEarliestDate = [];
                Object.keys(groupedByPack).forEach(packName => {
                    const packTodos = groupedByPack[packName];
                    const earliestDate = Math.min(...packTodos.map(t => new Date(t.due).getTime()));
                    packWithEarliestDate.push({ packName, earliestDate });
                });
                
                packWithEarliestDate.sort((a, b) => a.earliestDate - b.earliestDate);
                const sortedPackNames = packWithEarliestDate.map(p => p.packName);

                // 渲染有 pack 的項目
                sortedPackNames.forEach(packName => {
                    const packTodos = sortTodosInGroup(groupedByPack[packName]);
                    
                    // 使用所有項目（包括已完成）來計算百分比
                    const allPackTodos = allGroupedByPack[packName] || [];
                    const completedCount = allPackTodos.filter(t => t.completed).length;
                    const totalCount = allPackTodos.length;
                    const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                    
                    const earliestDue = packTodos.reduce((earliest, todo) => {
                        const todoDate = new Date(todo.due);
                        return todoDate < earliest ? todoDate : earliest;
                    }, new Date(packTodos[0].due));
                    const earliestDueStr = formatDate(earliestDue.toISOString().split('T')[0]);
                    
                    html += `<tr class="pack-header-row">`;
                    html += `<td colspan="14" style="padding: 12px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; font-size: 15px;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
                    html += `<span>📦 ${packName} <span style="font-size: 13px; font-weight: normal;">（最早：${earliestDueStr}）</span></span>`;
                    html += `<span style="font-size: 13px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px;">${completedCount}/${totalCount} 完成 (${progress}%)</span>`;
                    html += `</div>`;
                    html += `</td>`;
                    html += `</tr>`;
                    
                    packTodos.forEach(todo => {
                        html += renderTodoRow(todo, today, true);
                    });
                });

                // 渲染無 pack 的項目
                if (sortedNoPack.length > 0) {
                    if (sortedPackNames.length > 0) {
                        html += `<tr class="divider-row">`;
                        html += `<td colspan="14" style="padding: 10px 15px; background: #f0f0f0; color: #000; font-weight: 500; font-size: 14px;">其他待辦事項</td>`;
                        html += `</tr>`;
                    }
                    
                    sortedNoPack.forEach(todo => {
                        html += renderTodoRow(todo, today, false);
                    });
                }
            } else {
                // 其他排序模式：直接排序整個列表
                const sortedIncompleteTodos = sortTodosByMode([...incompleteTodos]);
                
                sortedIncompleteTodos.forEach(todo => {
                    html += renderTodoRow(todo, today, false);
                });
            }

            html += '</tbody></table>';

            // 已完成項目區域
            if (completedTodos.length > 0) {
                html += `
                    <div class="completed-section">
                        <div class="completed-header" onclick="toggleCompleted()">
                            <span id="completedToggleIcon">▶</span>
                            <span>已完成 (${completedTodos.length})</span>
                        </div>
                        <div id="completedList" style="display: none;">
                            <table class="todo-table"><thead><tr>
                                <th style="width: 50px; min-width: 50px; font-size: 14px;">✓</th>
                                <th style="min-width: 150px; font-size: 14px;">待辦事項</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">Category</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">Priority</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">Status</th>
                                <th style="width: 140px; min-width: 140px; font-size: 14px;">Due Date</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">Balance</th>
                                <th style="width: 150px; min-width: 150px; font-size: 14px;">Pack</th>
                                <th style="width: 200px; min-width: 200px; font-size: 14px;">Remark</th>
                                <th style="width: 120px; min-width: 120px; font-size: 14px;">操作</th>
                            </tr></thead><tbody>
                `;

                // 已完成項目也按 pack 分組
                const completedGrouped = {};
                const completedNoPack = [];
                
                completedTodos.forEach(todo => {
                    if (todo.combinepack && todo.combinepack.trim() !== '') {
                        if (!completedGrouped[todo.combinepack]) {
                            completedGrouped[todo.combinepack] = [];
                        }
                        completedGrouped[todo.combinepack].push(todo);
                    } else {
                        completedNoPack.push(todo);
                    }
                });

                // 渲染已完成的 pack 項目
                Object.keys(completedGrouped).sort().forEach(packName => {
                    const packTodos = completedGrouped[packName];
                    html += `<tr class="pack-header-row" style="opacity: 0.7;">`;
                    html += `<td colspan="14" style="padding: 10px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; font-size: 14px;">📦 ${packName}</td>`;
                    html += `</tr>`;
                    
                    packTodos.forEach(todo => {
                        html += renderTodoRow(todo, today, true);
                    });
                });

                // 渲染已完成的無 pack 項目
                completedNoPack.forEach(todo => {
                    html += renderTodoRow(todo, today, false);
                });

                html += '</tbody></table></div></div>';
            }

            todoList.innerHTML = html;
        }

        function renderTodoRow(todo, today, inPack) {
            const dueDate = new Date(todo.due);
            const isOverdue = !todo.completed && dueDate < today;
            const formattedDue = formatDate(todo.due);
            const balance = calculateBalance(todo.due, todo.completed);

            const priorityText = {
                veryhigh: '非常緊急!!',
                high: '緊急',
                medium: '普通',
                low: '不急',
                verylow: '非常不急'
            }[todo.priority];

            const statusText = {
                notstarted: '尚未開始',
                inprogress: '進行中',
                pending: '等待中',
                blocked: '受阻',
                completed: '已完成'
            }[todo.status] || (todo.status && todo.status.startsWith('custom:') ? todo.status.substring(7) : '-');

            const rowClass = `${todo.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''} priority-${todo.priority} ${inPack ? 'in-pack' : ''}`;

            let html = `<tr data-todo-id="${todo.id}" class="${rowClass}">`;
            
            // Select checkbox (for batch operations)
            html += `<td style="font-size: 12px; text-align: center;">`;
            html += `<input type="checkbox" class="select-item" data-todo-id="${todo.id}" style="width: 16px; height: 16px; cursor: pointer;" onclick="event.stopPropagation()" />`;
            html += `</td>`;
            
            // Complete checkbox with overdue alert
            html += `<td style="font-size: 12px; position: relative;">`;
            if (isOverdue) {
                html += `<span style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); font-size: 20px; animation: pulse 10s infinite; filter: drop-shadow(0 0 3px rgba(204, 0, 0, 0.8));" title="已過期！">⚠️</span>`;
            }
            html += `<input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleComplete(${todo.id})" style="width: 18px; height: 18px; cursor: pointer; ${isOverdue ? 'margin-left: 32px;' : ''}" />`;
            html += `</td>`;
            
            // 待辦事項名稱 - 可編輯
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'name', this)" style="font-size: 12px;">${todo.name}</td>`;
            
            // Category - 可編輯
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'category', this)" style="font-size: 12px;">${todo.category || '-'}</td>`;
            
            // Priority - 可編輯
            html += `<td class="editable-cell" onclick="editPriority(${todo.id}, this, event)" style="font-size: 12px;"><span class="priority-badge priority-${todo.priority}">${priorityText}</span></td>`;
            
            // Status - 可編輯
            html += `<td class="editable-cell" onclick="editStatus(${todo.id}, this, event)" style="font-size: 12px;">`;
            if (todo.status) {
                html += `<span class="status-badge status-${todo.status}">${statusText}</span>`;
            } else {
                html += '-';
            }
            html += `</td>`;
            
            // Due Date - 可編輯
            html += `<td class="editable-cell ${isOverdue ? 'overdue-text' : ''}" onclick="editField(${todo.id}, 'due', this)" style="font-size: 12px;">
                        📅 ${formattedDue}${isOverdue ? ' (逾期)' : ''}
                    </td>`;
            
            // Balance - 剩餘天數（不可編輯）
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);
            const balanceDueDate = new Date(todo.due);
            balanceDueDate.setHours(0, 0, 0, 0);
            const diffTime = balanceDueDate - todayDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let balanceStyle = 'font-size: 14px; font-weight: 600;';
            if (!todo.completed) {
                if (diffDays < 0) {
                    balanceStyle += ' color: #dc3545;'; // 紅色 - 逾期
                } else if (diffDays === 0) {
                    balanceStyle += ' color: #ff6b00;'; // 橘色 - 今天
                } else if (diffDays <= 3) {
                    balanceStyle += ' color: #ffc107;'; // 黃色 - 3天內
                } else {
                    balanceStyle += ' color: #28a745;'; // 綠色 - 充足時間
                }
            }
            
            html += `<td style="${balanceStyle}">${balance}</td>`;
            
            // 開始日期 - 可編輯
            const formattedStartDate = todo.startDate ? formatDate(todo.startDate) : '-';
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'startDate', this)" style="font-size: 12px;">
                        ${todo.startDate ? '📅 ' + formattedStartDate : '-'}
                    </td>`;
            
            // 處理週期 - 從開始日期到 Due Date 的天數
            let duration = '-';
            if (todo.startDate && todo.due) {
                const start = new Date(todo.startDate);
                start.setHours(0, 0, 0, 0);
                
                const end = new Date(todo.due);
                end.setHours(0, 0, 0, 0);
                
                const durationDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                
                if (durationDays >= 0) {
                    duration = `${durationDays} 天`;
                } else {
                    // 如果開始日期晚於到期日（負數）
                    duration = `${durationDays} 天`;
                }
            } else if (todo.startDate) {
                // 只有開始日期沒有 Due Date
                duration = '需設定到期日';
            }
            html += `<td style="font-size: 12px; font-weight: 500;" title="從開始日期到到期日的天數">${duration}</td>`;
            
            // 困難度 - 可編輯
            const difficultyInfo = {
                veryeasy: { text: '非常簡單', icon: '😊' },
                easy: { text: '簡單', icon: '🙂' },
                medium: { text: '普通', icon: '😐' },
                hard: { text: '困難', icon: '😰' },
                veryhard: { text: '非常困難', icon: '😱' }
            };
            const diff = difficultyInfo[todo.difficulty] || null;
            html += `<td class="editable-cell" onclick="editDifficulty(${todo.id}, this, event)" style="font-size: 12px;">
                        ${diff ? `${diff.icon} ${diff.text}` : '-'}
                    </td>`;
            
            // Combine Pack - 可編輯
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'combinepack', this)" style="font-size: 12px;">${todo.combinepack || '-'}</td>`;
            
            // Remark - 可編輯（允許換行）
            html += `<td class="editable-cell" onclick="editField(${todo.id}, 'remark', this)" style="font-size: 12px; word-wrap: break-word; word-break: break-word;">${todo.remark || '-'}</td>`;
            
            // 操作
            html += `<td style="font-size: 12px; position: relative;">`;
            if (isOverdue) {
                html += `<span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 20px; animation: pulse 10s infinite; filter: drop-shadow(0 0 3px rgba(204, 0, 0, 0.8));" title="已過期！">⚠️</span>`;
            }
            html += `
                <button onclick="copyTodo(${todo.id})" style="padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 3px;" title="複製">📋</button>
                <button class="delete-btn" onclick="deleteTodo(${todo.id})" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="刪除">🗑️</button>
            </td>`;
            
            html += '</tr>';
            return html;
        }

        // 編輯欄位
        function editField(id, field, cell) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            const currentValue = todo[field] || '';
            const isDateField = field === 'due' || field === 'startDate';

            if (isDateField) {
                // 日期欄位提供手動輸入和日期選擇器
                const inputId = `edit-${id}-${field}`;
                cell.innerHTML = `
                    <div style="display: flex; gap: 3px; flex-direction: column;">
                        <input type="text" id="${inputId}-manual" class="edit-input" value="${currentValue}" 
                               placeholder="YYYYMMDD或YYYY-MM-DD" 
                               style="font-size: 12px; padding: 4px;" />
                        <input type="date" id="${inputId}-picker" class="edit-input" value="${currentValue}" 
                               style="font-size: 12px; padding: 4px;" />
                    </div>
                `;
                
                const manualInput = document.getElementById(`${inputId}-manual`);
                const pickerInput = document.getElementById(`${inputId}-picker`);
                
                // 同步兩個輸入框
                manualInput.addEventListener('input', function() {
                    const parsed = parseManualDate(this.value);
                    if (parsed) pickerInput.value = parsed;
                });
                
                pickerInput.addEventListener('change', function() {
                    manualInput.value = this.value;
                });
                
                // 失焦時儲存
                const saveFunc = function() {
                    let finalValue = manualInput.value.trim();
                    if (finalValue) {
                        finalValue = parseManualDate(finalValue);
                        if (!finalValue) {
                            alert('日期格式錯誤！');
                            manualInput.focus();
                            return;
                        }
                    } else {
                        finalValue = pickerInput.value;
                    }
                    if (finalValue) {
                        saveField(id, field, finalValue);
                    } else {
                        renderTodos();
                    }
                };
                
                manualInput.addEventListener('blur', saveFunc);
                pickerInput.addEventListener('blur', saveFunc);
                manualInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') this.blur();
                });
                
                manualInput.focus();
            } else {
                cell.innerHTML = `<input type="text" class="edit-input" value="${currentValue}" onblur="saveField(${id}, '${field}', this.value)" onkeypress="if(event.key==='Enter') this.blur()" autofocus />`;
                cell.querySelector('input').focus();
            }
        }

        // 編輯優先級
        function editPriority(id, cell, event) {
            if (event) event.stopPropagation();
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            cell.innerHTML = `
                <select class="edit-select" onchange="saveField(${id}, 'priority', this.value)" onclick="event.stopPropagation()" autofocus>
                    <option value="veryhigh" ${todo.priority === 'veryhigh' ? 'selected' : ''}>非常緊急!!</option>
                    <option value="high" ${todo.priority === 'high' ? 'selected' : ''}>緊急</option>
                    <option value="medium" ${todo.priority === 'medium' ? 'selected' : ''}>普通</option>
                    <option value="low" ${todo.priority === 'low' ? 'selected' : ''}>不急</option>
                    <option value="verylow" ${todo.priority === 'verylow' ? 'selected' : ''}>非常不急</option>
                </select>
            `;
            const select = cell.querySelector('select');
            select.focus();
            select.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // 編輯狀態
        function editStatus(id, cell, event) {
            if (event) event.stopPropagation();
            const todo = todos.find(t => t.id === id);
            if (!todo) return;
            
            const customStatus = todo.status && todo.status.startsWith('custom:') ? todo.status.substring(7) : '';

            cell.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <select class="edit-select" id="statusSelect_${id}" onchange="handleStatusChange(${id}, this.value)" onclick="event.stopPropagation()" autofocus>
                        <option value="">未設定</option>
                        <option value="notstarted" ${todo.status === 'notstarted' ? 'selected' : ''}>尚未開始</option>
                        <option value="inprogress" ${todo.status === 'inprogress' ? 'selected' : ''}>進行中</option>
                        <option value="pending" ${todo.status === 'pending' ? 'selected' : ''}>等待中</option>
                        <option value="blocked" ${todo.status === 'blocked' ? 'selected' : ''}>受阻</option>
                        <option value="completed" ${todo.status === 'completed' ? 'selected' : ''}>已完成</option>
                        <option value="custom" ${todo.status && todo.status.startsWith('custom:') ? 'selected' : ''}>其他...</option>
                    </select>
                    <input type="text" 
                           id="customStatusInput_${id}" 
                           class="edit-input" 
                           placeholder="輸入自訂狀態"
                           value="${customStatus}"
                           style="display: ${todo.status && todo.status.startsWith('custom:') ? 'block' : 'none'}; padding: 8px; border: 2px solid #667eea; border-radius: 4px; font-size: 14px;"
                           onblur="saveCustomStatus(${id})"
                           onkeypress="if(event.key==='Enter') saveCustomStatus(${id})"
                           onclick="event.stopPropagation()">
                </div>
            `;
            const select = cell.querySelector('select');
            select.focus();
            select.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // 處理狀態變更
        function handleStatusChange(id, value) {
            const customInput = document.getElementById(`customStatusInput_${id}`);
            
            if (value === 'custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                saveField(id, 'status', value);
            }
        }

        // 儲存自訂狀態
        function saveCustomStatus(id) {
            const input = document.getElementById(`customStatusInput_${id}`);
            const customValue = input.value.trim();
            
            if (customValue) {
                saveField(id, 'status', 'custom:' + customValue);
            } else {
                saveField(id, 'status', '');
            }
        }

        // 編輯困難度
        function editDifficulty(id, cell, event) {
            if (event) event.stopPropagation();
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            cell.innerHTML = `
                <select class="edit-select" onchange="saveField(${id}, 'difficulty', this.value)" onclick="event.stopPropagation()" autofocus>
                    <option value="">未設定</option>
                    <option value="veryeasy" ${todo.difficulty === 'veryeasy' ? 'selected' : ''}>😊 非常簡單</option>
                    <option value="easy" ${todo.difficulty === 'easy' ? 'selected' : ''}>🙂 簡單</option>
                    <option value="medium" ${todo.difficulty === 'medium' ? 'selected' : ''}>😐 普通</option>
                    <option value="hard" ${todo.difficulty === 'hard' ? 'selected' : ''}>😰 困難</option>
                    <option value="veryhard" ${todo.difficulty === 'veryhard' ? 'selected' : ''}>😱 非常困難</option>
                </select>
            `;
            const select = cell.querySelector('select');
            select.focus();
            select.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // 儲存欄位
        function saveField(id, field, value) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            if (field === 'name' && !value.trim()) {
                alert('待辦事項名稱不能空白！');
                renderTodos();
                return;
            }

            if (field === 'due' && !value) {
                alert('截止日期不能空白！');
                renderTodos();
                return;
            }

            saveToHistory();
            todo[field] = value;
            saveTodos();
            updateStatistics();
            renderTodos();
        }

        function toggleCompleted() {
            const completedList = document.getElementById('completedList');
            const icon = document.getElementById('completedToggleIcon');
            if (completedList.style.display === 'none') {
                completedList.style.display = 'block';
                icon.textContent = '▼';
            } else {
                completedList.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        function calculateBalance(dueDate, isCompleted) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (isCompleted) {
                return '✅ 已完成';
            } else if (diffDays < 0) {
                return `⏰ 逾期 ${Math.abs(diffDays)} 天`;
            } else if (diffDays === 0) {
                return '🔥 今天到期';
            } else {
                return `⏳ 剩餘 ${diffDays} 天`;
            }
        }

        // 匯出資料
        function exportData() {
            // 匯出所有資料，包含標題和設定
            const allData = {
                version: '2.8',
                exportDate: new Date().toISOString(),
                customTitle: localStorage.getItem('customTitle') || '📝 待辦事項清單 v2025.01',
                todos: todos,
                settings: {
                    // 可以在這裡加入其他設定
                }
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const today = new Date().toISOString().split('T')[0];
            link.download = `todo-list-complete-backup-${today}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('✅ 完整資料已匯出！包含標題、待辦事項和所有設定。可儲存到雲端硬碟同步到其他裝置。');
        }

        // 匯入資料
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 檢查是否為新格式（完整備份）
                    if (importedData.version && importedData.todos) {
                        const confirmation = confirm(
                            `確定要匯入完整資料嗎？\n\n` +
                            `• 待辦事項：${importedData.todos.length} 筆\n` +
                            `• 標題：${importedData.customTitle || '預設標題'}\n` +
                            `• 匯出日期：${importedData.exportDate ? new Date(importedData.exportDate).toLocaleString('zh-TW') : '未知'}\n\n` +
                            `這會覆蓋目前所有資料！`
                        );
                        
                        if (confirmation) {
                            // 匯入標題
                            if (importedData.customTitle) {
                                localStorage.setItem('customTitle', importedData.customTitle);
                                document.getElementById('mainTitle').innerHTML = importedData.customTitle;
                            }
                            
                            // 匯入待辦事項
                            todos = importedData.todos;
                            saveTodos();
                            updateStatistics();
                            renderTodos();
                            
                            showToast('✅ 完整資料匯入成功！包含標題和所有待辦事項。');
                        }
                    }
                    // 舊格式（只有 todos 陣列）
                    else if (Array.isArray(importedData)) {
                        const confirmation = confirm(`確定要匯入資料嗎？\n\n這會覆蓋目前的 ${todos.length} 筆資料，\n匯入 ${importedData.length} 筆新資料。`);
                        
                        if (confirmation) {
                            todos = importedData;
                            saveTodos();
                            updateStatistics();
                            renderTodos();
                            showToast('✅ 資料匯入成功！');
                        }
                    } else {
                        alert('❌ 檔案格式錯誤！');
                        return;
                    }
                } catch (error) {
                    alert('❌ 檔案讀取失敗！請確認檔案格式正確。\n錯誤：' + error.message);
                }
            };
            reader.readAsText(file);
            
            // 重置 file input
            event.target.value = '';
        }

        // ==================== 初始化 ====================
        // 頁面載入完成後初始化
        loadTitle(); // 載入自訂標題
        updateCurrentDate();
        setInterval(updateCurrentDate, 1000); // 每秒更新時間
        updateStatistics();
        updateUndoButton();
        updateFilterCount(); // 初始化篩選計數
        renderTodos();

        // 同步手動輸入和日期選擇器
        document.getElementById('dueDateManual').addEventListener('input', function(e) {
            const value = e.target.value.trim();
            const formatted = parseManualDate(value);
            if (formatted) {
                document.getElementById('dueInput').value = formatted;
            }
        });

        document.getElementById('dueInput').addEventListener('change', function(e) {
            document.getElementById('dueDateManual').value = e.target.value;
        });

        // ========== 複製貼上功能增強 ==========
        
        // 1. 支援表格內文字選取和複製到外部（Excel、Word 等）
        document.addEventListener('copy', function(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString();
            
            if (selectedText) {
                // 允許正常的文字複製
                e.clipboardData.setData('text/plain', selectedText);
                
                // 如果選取的是表格內容，也提供 HTML 格式（可貼到 Excel）
                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;
                
                // 檢查是否在表格內
                let tableElement = container.nodeType === 3 ? container.parentElement : container;
                while (tableElement && tableElement.tagName !== 'TABLE') {
                    tableElement = tableElement.parentElement;
                    if (tableElement === document.body) {
                        tableElement = null;
                        break;
                    }
                }
                
                if (tableElement) {
                    // 在表格內，提供 HTML 格式以便貼到 Excel
                    const div = document.createElement('div');
                    div.appendChild(range.cloneContents());
                    e.clipboardData.setData('text/html', div.innerHTML);
                }
                
                e.preventDefault();
                showToast('✅ 已複製到剪貼簿');
            }
        });

        // 2. 支援 Ctrl+C/Cmd+C 快速複製整行
        let lastClickedTodoId = null;
        
        document.addEventListener('click', function(e) {
            const row = e.target.closest('tr');
            if (row && row.dataset.todoId) {
                lastClickedTodoId = parseInt(row.dataset.todoId);
            }
        });

        document.addEventListener('keydown', function(e) {
            // Ctrl+C 或 Cmd+C（Mac）
            if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                // 如果沒有選取文字，則複製整個待辦事項
                const selection = window.getSelection();
                if (!selection.toString() && lastClickedTodoId) {
                    e.preventDefault();
                    copyTodo(lastClickedTodoId);
                }
            }
            
            // Ctrl+V 或 Cmd+V（Mac）
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                // 如果焦點不在輸入框上，則貼上待辦事項
                const activeElement = document.activeElement;
                const isInputField = activeElement.tagName === 'INPUT' || 
                                   activeElement.tagName === 'TEXTAREA' || 
                                   activeElement.tagName === 'SELECT' ||
                                   activeElement.isContentEditable;
                
                if (!isInputField) {
                    e.preventDefault();
                    pasteTodo();
                }
            }
        });

        // 3. 增強 renderTodoRow - 添加 data-todo-id 以便識別
        const originalRenderTodoRow = renderTodoRow;
        renderTodoRow = function(todo, inPack) {
            let html = originalRenderTodoRow(todo, inPack);
            // 在 <tr 標籤中添加 data-todo-id
            html = html.replace('<tr class=', `<tr data-todo-id="${todo.id}" class=`);
            return html;
        };

        // 4. 右鍵選單支援（可選）
        document.addEventListener('contextmenu', function(e) {
            const row = e.target.closest('tr');
            if (row && row.dataset.todoId) {
                const todoId = parseInt(row.dataset.todoId);
                
                // 創建自訂右鍵選單
                e.preventDefault();
                
                // 移除舊選單（如果存在）
                const oldMenu = document.getElementById('customContextMenu');
                if (oldMenu) oldMenu.remove();
                
                // 創建選單
                const menu = document.createElement('div');
                menu.id = 'customContextMenu';
                menu.style.cssText = `
                    position: fixed;
                    left: ${e.pageX}px;
                    top: ${e.pageY}px;
                    background: white;
                    border: 1px solid #ccc;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    padding: 8px 0;
                    z-index: 10000;
                    min-width: 150px;
                `;
                
                const menuItems = [
                    { text: '📋 複製此項目', action: () => copyTodo(todoId) },
                    { text: '📋 貼上', action: () => pasteTodo() },
                    { text: '---', action: null },
                    { text: '🗑️ 刪除', action: () => deleteTodo(todoId) }
                ];
                
                menuItems.forEach(item => {
                    if (item.text === '---') {
                        const divider = document.createElement('div');
                        divider.style.cssText = 'height: 1px; background: #ddd; margin: 5px 0;';
                        menu.appendChild(divider);
                    } else {
                        const menuItem = document.createElement('div');
                        menuItem.textContent = item.text;
                        menuItem.style.cssText = `
                            padding: 10px 20px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.2s;
                        `;
                        menuItem.onmouseover = () => menuItem.style.background = '#f0f0f0';
                        menuItem.onmouseout = () => menuItem.style.background = 'white';
                        menuItem.onclick = () => {
                            item.action();
                            menu.remove();
                        };
                        menu.appendChild(menuItem);
                    }
                });
                
                document.body.appendChild(menu);
                
                // 點擊其他地方關閉選單
                setTimeout(() => {
                    const closeMenu = (e) => {
                        if (!menu.contains(e.target)) {
                            menu.remove();
                            document.removeEventListener('click', closeMenu);
                        }
                    };
                    document.addEventListener('click', closeMenu);
                }, 0);
            }
        });

        // 5. 批量複製功能（可選）- 複製整個表格到 Excel
        function copyTableToClipboard() {
            const table = document.querySelector('#todoList table');
            if (!table) {
                alert('沒有資料可複製！');
                return;
            }
            
            // 創建一個臨時元素來選取整個表格
            const range = document.createRange();
            range.selectNode(table);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                // 執行複製命令
                document.execCommand('copy');
                selection.removeAllRanges();
                showToast('✅ 表格已複製！可貼到 Excel');
            } catch (err) {
                alert('複製失敗：' + err);
            }
        }

        // 6. 單元格選取時不觸發編輯（按住 Ctrl 或 Shift）
        let isSelectingText = false;
        
        document.addEventListener('mousedown', function(e) {
            if (e.ctrlKey || e.shiftKey) {
                isSelectingText = true;
            }
        });
        
        document.addEventListener('mouseup', function(e) {
            setTimeout(() => {
                isSelectingText = false;
            }, 100);
        });

        // 修改單元格點擊事件，避免選取文字時觸發編輯
        const editableClickHandler = function(id, field, cell, event, originalHandler) {
            if (isSelectingText) {
                event.stopPropagation();
                return;
            }
            
            // 如果有選取文字，不觸發編輯
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                return;
            }
            
            originalHandler(id, field, cell, event);
        };

        // 提示訊息
        console.log('✅ 複製貼上功能已啟用！');
        console.log('📋 功能說明：');
        console.log('1. 選取文字後 Ctrl+C：複製文字到外部（Excel、Word 等）');
        console.log('2. 點選一行後 Ctrl+C：複製整個待辦事項');
        console.log('3. Ctrl+V：貼上待辦事項');
        console.log('4. 右鍵點擊：顯示快捷選單');
        console.log('5. 選取表格內容可直接複製到 Excel');
        
        // ========== 複製貼上功能增強結束 ==========

        // ========== 自動更新日期檢查 ==========
        
        // 記錄上次檢查的日期
        let lastCheckDate = new Date().toDateString();
        
        // 每分鐘檢查一次日期是否變更
        setInterval(function() {
            const currentDate = new Date().toDateString();
            
            if (currentDate !== lastCheckDate) {
                // 日期改變了！
                console.log('📅 日期已更新：從', lastCheckDate, '到', currentDate);
                lastCheckDate = currentDate;
                
                // 重新渲染所有項目（更新過期狀態）
                updateStatistics();
                renderTodos();
                
                // 顯示提示
                showDateChangeNotification();
            }
        }, 60000); // 每分鐘檢查一次
        
        // 頁面載入時顯示當前日期
        function showCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            const timeStr = now.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            console.log('📅 當前日期時間：', dateStr, timeStr);
        }
        
        // 儲存標題
        function saveTitle() {
            const title = document.getElementById('mainTitle');
            const titleText = title.textContent || title.innerText;
            localStorage.setItem('customTitle', titleText);
            console.log('✓ 標題已儲存：', titleText);
        }
        
        // 載入標題
        function loadTitle() {
            const savedTitle = localStorage.getItem('customTitle');
            if (savedTitle) {
                document.getElementById('mainTitle').innerHTML = savedTitle;
                console.log('✓ 已載入自訂標題');
            }
        }
        
        // 顯示日期變更通知
        function showDateChangeNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px 50px;
                border-radius: 15px;
                font-size: 18px;
                font-weight: 600;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                animation: fadeIn 0.5s ease;
            `;
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            notification.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">📅</div>
                <div style="font-size: 20px; margin-bottom: 10px;">日期已更新</div>
                <div style="font-size: 16px; opacity: 0.9;">${dateStr}</div>
                <div style="font-size: 12px; margin-top: 15px; opacity: 0.8;">過期狀態已自動更新</div>
            `;
            
            document.body.appendChild(notification);
            
            // 3 秒後自動關閉
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // 添加淡入淡出動畫
        const dateUpdateStyle = document.createElement('style');
        dateUpdateStyle.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            }
        `;
        document.head.appendChild(dateUpdateStyle);
        
        // 頁面載入時顯示當前日期
        showCurrentDate();
        
        // 每小時更新一次日期顯示
        setInterval(showCurrentDate, 3600000);
        
        console.log('✅ 自動日期更新功能已啟用');
        console.log('⏰ 每分鐘檢查一次日期變更');
        console.log('📅 日期改變時會自動更新過期狀態');
        
        // ========== 自動更新日期檢查結束 ==========
        
        // ========== 開始日期快速輸入同步 ==========
        
        // 同步開始日期手動輸入和日期選擇器
        document.getElementById('startDateManual').addEventListener('input', function(e) {
            const input = e.target.value.trim();
            if (!input) {
                document.getElementById('startDateInput').value = '';
                return;
            }
            
            // 解析輸入（支援 1023, 10-23, 10/23 等格式）
            let month, day;
            
            if (/^\d{4}$/.test(input)) {
                // 格式：1023
                month = parseInt(input.substring(0, 2));
                day = parseInt(input.substring(2, 4));
            } else if (/^\d{1,2}[-\/]\d{1,2}$/.test(input)) {
                // 格式：10-23 或 10/23
                const parts = input.split(/[-\/]/);
                month = parseInt(parts[0]);
                day = parseInt(parts[1]);
            } else {
                return; // 格式不正確，不處理
            }
            
            // 驗證日期
            if (month < 1 || month > 12 || day < 1 || day > 31) {
                return;
            }
            
            // 使用當前年份
            const year = new Date().getFullYear();
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            document.getElementById('startDateInput').value = dateStr;
        });
        
        // 同步日期選擇器到手動輸入
        document.getElementById('startDateInput').addEventListener('change', function(e) {
            const dateValue = e.target.value;
            if (dateValue) {
                const date = new Date(dateValue);
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                document.getElementById('startDateManual').value = `${month}${day}`;
            } else {
                document.getElementById('startDateManual').value = '';
            }
        });
        
        console.log('✅ 開始日期快速輸入已啟用');
        console.log('📅 範例：輸入 1023 = 今年10月23日');
        
        // ========== 開始日期快速輸入結束 ==========
    </script>
</body>
</html>